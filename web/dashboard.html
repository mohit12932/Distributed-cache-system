<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Cache System &mdash; Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#0a0a14;color:#e0e0e0;min-height:100vh}
        .c{max-width:1600px;margin:0 auto;padding:16px 20px}

        /* ── Header ── */
        header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:linear-gradient(135deg,#12122a 0%,#14203a 100%);border-radius:10px;margin-bottom:14px;border:1px solid #1f3460}
        header h1{font-size:1.45em;color:#fff}
        header h1 span{color:#00d4ff}
        .hdr-right{display:flex;align-items:center;gap:14px}
        .badge{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:16px;font-size:.78em;font-weight:600}
        .badge.on{background:rgba(76,175,80,.15);color:#4caf50;border:1px solid #4caf50}
        .badge.off{background:rgba(244,67,54,.15);color:#f44336;border:1px solid #f44336}
        .toggle-wrap{display:flex;align-items:center;gap:8px}
        .toggle-lbl{font-size:.82em;font-weight:700;transition:color .3s}
        .toggle-lbl.active{color:#4caf50}
        .toggle-lbl.inactive{color:#546e7a}
        .toggle-sw{position:relative;display:inline-block;width:44px;height:22px}
        .toggle-sw input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#f44336;border-radius:22px;transition:all .3s}
        .toggle-slider:before{content:'';position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:all .3s}
        .toggle-sw input:checked+.toggle-slider{background:#4caf50;box-shadow:0 0 12px rgba(76,175,80,.4)}
        .toggle-sw input:checked+.toggle-slider:before{transform:translateX(22px)}
        .dot{width:7px;height:7px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

        /* ── Status Bar ── */
        .status-bar{display:flex;gap:0;margin-bottom:14px;border-radius:10px;overflow:hidden;border:1px solid #1f3460}
        .sb-item{flex:1;padding:10px 14px;background:#12122a;text-align:center;border-right:1px solid #1f3460}
        .sb-item:last-child{border-right:none}
        .sb-label{font-size:.65em;color:#546e7a;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
        .sb-val{font-size:.88em;font-weight:700}

        /* ── KPI cards ── */
        .kpi-row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:16px}
        .kpi{background:#12122a;border-radius:10px;padding:16px 10px;text-align:center;border:1px solid #1f3460;transition:border-color .3s}
        .kpi .v{font-size:2em;font-weight:700;line-height:1.1}
        .kpi .l{font-size:.72em;color:#546e7a;margin-top:4px}
        .kpi .sub{font-size:.68em;margin-top:2px}

        /* ── Grid ── */
        .g2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}

        /* ── Card ── */
        .card{background:#12122a;border-radius:10px;padding:16px 18px;border:1px solid #1f3460}
        .card h3{font-size:.92em;color:#8892b0;margin-bottom:10px;display:flex;align-items:center;gap:7px}
        canvas{max-height:230px}

        /* ── Colors ── */
        .c-blue{color:#00d4ff}.c-green{color:#4caf50}.c-orange{color:#ff9800}.c-red{color:#f44336}.c-purple{color:#bb86fc}.c-gray{color:#546e7a}

        /* ── Burst bar ── */
        .burst-bar{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:10px 18px;background:linear-gradient(135deg,#1a0a2a,#0e1a3a);border-radius:10px;border:1px solid #4a1a7a;flex-wrap:wrap}
        .burst-bar label{font-size:.78em;color:#8892b0}
        .burst-bar input[type=text]{width:140px;padding:5px 8px;border:1px solid #4a1a7a;border-radius:5px;background:#0a0a14;color:#e0e0e0;font-size:.82em}
        .burst-bar input[type=number]{width:52px;padding:5px 6px;border:1px solid #4a1a7a;border-radius:5px;background:#0a0a14;color:#e0e0e0;font-size:.82em;text-align:center}
        .bbtn{padding:6px 16px;border:none;border-radius:7px;font-weight:700;font-size:.8em;cursor:pointer;transition:all .2s}
        .bbtn.fire{background:linear-gradient(135deg,#f44336,#ff5722);color:#fff}
        .bbtn.fire:hover{filter:brightness(1.2);box-shadow:0 0 14px rgba(244,67,54,.5)}
        .bbtn.stop{background:rgba(76,175,80,.12);color:#4caf50;border:1px solid #4caf50}
        .bbtn.stop:hover{background:rgba(76,175,80,.25)}


        /* ── Stroke alert ── */
        .stroke-alert{display:none;align-items:center;gap:10px;padding:12px 18px;margin-bottom:14px;background:rgba(244,67,54,.1);border:1px solid #f44336;border-radius:10px;animation:blink 1s infinite}
        .stroke-alert.active{display:flex}
        .sa-icon{font-size:1.5em}.sa-text{font-size:.88em;color:#ef5350;font-weight:600}.sa-detail{font-size:.75em;color:#ef9a9a}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.45}}

        /* ── PINN equation inline ── */
        .pinn-eq-inline{margin-left:auto;font-family:'Cambria Math','Times New Roman',serif;font-size:.82em;color:#ce93d8;background:rgba(187,134,252,.08);padding:2px 10px;border-radius:5px;border:1px solid rgba(187,134,252,.18);white-space:nowrap}

        /* ── Node Topology ── */
        .topo-svg{width:100%;height:auto}
        .topo-svg text{font-family:'Segoe UI',sans-serif}

        /* ── Merged Segment Grid (Heat + Lock) ── */
        .sg-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px}
        .sg{aspect-ratio:1.5;border-radius:5px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.68em;font-weight:700;transition:all .3s;border:2px solid transparent}
        .sg .sg-heat{font-size:.95em;margin:1px 0}
        .sg .sg-lock{font-size:.7em;opacity:.82;margin-top:1px;padding:0 3px;border-radius:2px}
        .sg-cold{background:#1a3a5c;color:#64b5f6}.sg-warm{background:#2e4a1e;color:#81c784}.sg-hot{background:#5c3a0a;color:#ffb74d}.sg-stroke{background:#5c1a1a;color:#ef5350;animation:blink .6s infinite}
        .sg-lk-free{border-color:transparent}.sg-lk-shared{border-color:#2196F3}.sg-lk-excl{border-color:#ff9800}.sg-lk-cont{border-color:#f44336;animation:blink .5s infinite}
        .sg-legend{display:flex;gap:10px;justify-content:center;margin-top:10px;font-size:.7em;color:#546e7a;flex-wrap:wrap}
        .sg-legend span{display:flex;align-items:center;gap:4px}
        .sw{width:12px;height:12px;border-radius:3px;display:inline-block}

        /* ── WB Pipeline ── */
        .wb-flow{display:flex;align-items:center;gap:0;padding:12px 6px;overflow-x:auto}
        .wb-stg{flex:0 0 auto;text-align:center}
        .wb-box{width:100px;padding:8px 6px;border-radius:7px;border:2px solid #1f3460;background:#0e1a2e;font-size:.73em;font-weight:600;transition:all .3s}
        .wb-box.a{border-color:#4caf50;box-shadow:0 0 10px rgba(76,175,80,.25)}.wb-box.h{border-color:#ff9800;box-shadow:0 0 10px rgba(255,152,0,.25)}.wb-box.s{border-color:#f44336;box-shadow:0 0 10px rgba(244,67,54,.3);animation:blink .7s infinite}
        .wb-v{font-size:1.2em;font-weight:700;margin:3px 0}
        .wb-l{font-size:.65em;color:#546e7a}
        .wb-arr{flex:0 0 32px;text-align:center;font-size:1em;color:#1f3460}
        .wb-arr.on{color:#4caf50;animation:ap 1s infinite}
        @keyframes ap{0%,100%{opacity:.35}50%{opacity:1}}
        .wb-divider{height:1px;background:linear-gradient(90deg,transparent,#1f3460,transparent);margin:10px 0}
        .wb-ev-title{font-size:.78em;color:#546e7a;margin-bottom:6px;text-transform:uppercase;letter-spacing:.4px}

        /* ── Event log ── */
        .evlog{max-height:180px;overflow-y:auto;font-family:'Consolas','Courier New',monospace;font-size:.76em;line-height:1.7}
        .evlog::-webkit-scrollbar{width:5px}.evlog::-webkit-scrollbar-thumb{background:#1f3460;border-radius:3px}
        .ev{display:flex;gap:8px;padding:2px 4px;border-radius:4px;border-bottom:1px solid rgba(31,52,96,.3)}
        .ev:hover{background:rgba(255,255,255,.03)}
        .ev-t{color:#546e7a;min-width:60px}.ev-s{font-weight:700;min-width:30px}.ev-a{font-weight:600;min-width:65px}.ev-d{color:#8892b0}
        .ev-pinn .ev-s{color:#bb86fc}.ev-pinn .ev-a{color:#ce93d8}
        .ev-wb .ev-s{color:#ff9800}.ev-wb .ev-a{color:#4caf50}
        .ev-lock .ev-s{color:#f44336}.ev-lock .ev-a{color:#ff9800}
        .ev-req .ev-s{color:#00d4ff}.ev-req .ev-a{color:#4caf50}

        /* ── Responsive ── */
        @media(max-width:1100px){.kpi-row{grid-template-columns:repeat(3,1fr)}}
        @media(max-width:700px){.kpi-row{grid-template-columns:repeat(2,1fr)}.g2{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="c">

    <!-- ═══ HEADER ═══ -->
    <header>
        <h1>Distributed <span>Cache</span> System</h1>
        <div class="hdr-right">
            <div class="badge on" id="badge"><div class="dot"></div><span id="badgeTxt">Connected</span></div>
            <div class="toggle-wrap">
                <span class="toggle-lbl inactive" id="togOff">OFF</span>
                <label class="toggle-sw">
                    <input type="checkbox" id="togInput" checked onchange="toggleSystem(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-lbl active" id="togOn">ON</span>
            </div>
        </div>
    </header>

    <!-- ═══ STATUS BAR ═══ -->
    <div class="status-bar">
        <div class="sb-item"><div class="sb-label">Server</div><div class="sb-val c-green" id="sbServer">ONLINE</div></div>
        <div class="sb-item"><div class="sb-label">Write Mode</div><div class="sb-val c-blue" id="sbMode">Write-Back</div></div>
        <div class="sb-item"><div class="sb-label">Segments</div><div class="sb-val c-blue" id="sbSegs">32 Active</div></div>
        <div class="sb-item"><div class="sb-label">PINN Engine</div><div class="sb-val c-purple" id="sbPinn">Normal</div></div>
        <div class="sb-item"><div class="sb-label">Lock Health</div><div class="sb-val c-green" id="sbLock">All Free</div></div>
        <div class="sb-item"><div class="sb-label">WB Queue</div><div class="sb-val c-green" id="sbWB">Idle</div></div>
    </div>

    <!-- ═══ KPI ROW ═══ -->
    <div class="kpi-row">
        <div class="kpi"><div class="v c-blue" id="kTotalOps">0</div><div class="l">Total Operations</div></div>
        <div class="kpi"><div class="v c-green" id="kOps">0</div><div class="l">Ops / Second</div></div>
        <div class="kpi">
            <div class="v c-orange" id="kHitRate">0%</div><div class="l">Cache Hit Rate</div>
            <div class="sub"><span class="c-green" id="kHits">0</span> hits &middot; <span class="c-red" id="kMiss">0</span> misses</div>
        </div>
        <div class="kpi"><div class="v c-purple" id="kKeys">0</div><div class="l">Active Keys</div></div>
        <div class="kpi"><div class="v c-green" id="kFlushed">0</div><div class="l">WB Flushed to Disk</div></div>
        <div class="kpi"><div class="v c-red" id="kContentions">0</div><div class="l">Lock Contentions</div></div>
    </div>

    <!-- ═══ BURST BAR (Multi-Segment) ═══ -->
    <div class="burst-bar">
        <span style="color:#bb86fc;font-weight:700;font-size:.88em">PINN Burst</span>
        <label>Segments</label>
        <input type="text" id="burstSegs" value="14" placeholder="e.g. 14,15,16">
        <label>Power</label><input type="number" id="burstPow" value="30" min="1" max="50">
        <button class="bbtn fire" onclick="fireBurst()">FIRE BURST</button>
        <button class="bbtn stop" onclick="stopBurst()">STOP</button>
        <span style="margin-left:auto;font-size:.75em;color:#546e7a" id="burstStatus">Ready</span>
    </div>

    <div class="stroke-alert" id="strokeAlert">
        <div class="sa-icon">&#9888;</div>
        <div><div class="sa-text" id="strokeText">HEAT STROKE DETECTED</div><div class="sa-detail" id="strokeDetail"></div></div>
    </div>

    <!-- ═══ ROW 1: Traffic + Segment Status ═══ -->
    <div class="g2">
        <div class="card">
            <h3>Traffic Over Time</h3>
            <canvas id="trafficChart"></canvas>
        </div>
        <div class="card">
            <h3>Segment Status &mdash; Heat &amp; Lock</h3>
            <div class="sg-grid" id="segGrid"></div>
            <div class="sg-legend">
                <span><div class="sw" style="background:#1a3a5c"></div> Cold</span>
                <span><div class="sw" style="background:#2e4a1e"></div> Warm</span>
                <span><div class="sw" style="background:#5c3a0a"></div> Hot</span>
                <span><div class="sw" style="background:#5c1a1a"></div> Stroke</span>
                <span style="color:#1f3460">|</span>
                <span><div class="sw" style="border:2px solid transparent;background:#12122a"></div> FREE</span>
                <span><div class="sw" style="border:2px solid #2196F3;background:#12122a"></div> SHARED</span>
                <span><div class="sw" style="border:2px solid #ff9800;background:#12122a"></div> EXCL</span>
                <span><div class="sw" style="border:2px solid #f44336;background:#12122a"></div> CONTEND</span>
            </div>
        </div>
    </div>

    <!-- ═══ ROW 2: Node Topology + PINN ═══ -->
    <div class="g2">
        <div class="card">
            <h3>Network Node Topology</h3>
            <svg viewBox="0 0 500 260" class="topo-svg" xmlns="http://www.w3.org/2000/svg">
                <!-- Connection lines: Client → each Node -->
                <line x1="65" y1="55" x2="245" y2="42" stroke="#1f3460" stroke-width="1.5" stroke-dasharray="5,4" id="connLineA"/>
                <line x1="65" y1="55" x2="425" y2="55" stroke="#1f3460" stroke-width="1.5" stroke-dasharray="5,4" id="connLineB"/>
                <line x1="65" y1="55" x2="425" y2="195" stroke="#1f3460" stroke-width="1.5" stroke-dasharray="5,4" id="connLineC"/>
                <line x1="65" y1="55" x2="245" y2="218" stroke="#1f3460" stroke-width="1.5" stroke-dasharray="5,4" id="connLineD"/>

                <!-- Flow labels along each path -->
                <text x="155" y="38" fill="#546e7a" font-size="8" id="flowLabelA">0 req/s</text>
                <text x="245" y="46" fill="#546e7a" font-size="8" text-anchor="middle" id="flowLabelB">0 req/s</text>
                <text x="260" y="138" fill="#546e7a" font-size="8" id="flowLabelC">0 req/s</text>
                <text x="135" y="150" fill="#546e7a" font-size="8" id="flowLabelD">0 req/s</text>

                <!-- Single animated flow dot (JS-driven, one path at a time) -->
                <circle r="3.5" fill="#00d4ff" id="flowDot" cx="65" cy="55" opacity="0"/>

                <!-- Client Node (circle, top-left) -->
                <circle cx="65" cy="55" r="26" fill="#0e1a2e" stroke="#00d4ff" stroke-width="2.5" id="clientCircle"/>
                <text x="65" y="52" text-anchor="middle" fill="#00d4ff" font-size="9.5" font-weight="700">Client</text>
                <text x="65" y="65" text-anchor="middle" fill="#546e7a" font-size="7.5" id="topoLB">0 ops/s</text>

                <!-- Node A (S0-S7) — top right -->
                <rect x="190" y="18" width="110" height="42" rx="7" fill="#0e1a2e" stroke="#1f3460" stroke-width="1.5" id="topoRectA"/>
                <text x="245" y="36" text-anchor="middle" fill="#64b5f6" font-size="9" font-weight="700">Node A</text>
                <text x="245" y="52" text-anchor="middle" fill="#546e7a" font-size="7.5" id="topoInfoA">S0-S7 | 0 req</text>

                <!-- Node B (S8-S15) — far right -->
                <rect x="370" y="34" width="110" height="42" rx="7" fill="#0e1a2e" stroke="#1f3460" stroke-width="1.5" id="topoRectB"/>
                <text x="425" y="52" text-anchor="middle" fill="#64b5f6" font-size="9" font-weight="700">Node B</text>
                <text x="425" y="68" text-anchor="middle" fill="#546e7a" font-size="7.5" id="topoInfoB">S8-S15 | 0 req</text>

                <!-- Node C (S16-S23) — bottom right -->
                <rect x="370" y="174" width="110" height="42" rx="7" fill="#0e1a2e" stroke="#1f3460" stroke-width="1.5" id="topoRectC"/>
                <text x="425" y="192" text-anchor="middle" fill="#64b5f6" font-size="9" font-weight="700">Node C</text>
                <text x="425" y="208" text-anchor="middle" fill="#546e7a" font-size="7.5" id="topoInfoC">S16-S23 | 0 req</text>

                <!-- Node D (S24-S31) — bottom center -->
                <rect x="190" y="197" width="110" height="42" rx="7" fill="#0e1a2e" stroke="#1f3460" stroke-width="1.5" id="topoRectD"/>
                <text x="245" y="215" text-anchor="middle" fill="#64b5f6" font-size="9" font-weight="700">Node D</text>
                <text x="245" y="231" text-anchor="middle" fill="#546e7a" font-size="7.5" id="topoInfoD">S24-S31 | 0 req</text>
            </svg>
        </div>
        <div class="card" style="border-color:#4a1a7a">
            <h3 style="color:#bb86fc">PINN &mdash; Actual vs Predicted Heat <span class="pinn-eq-inline">&part;u/&part;t + u&middot;&part;u/&part;x = &nu;&middot;&part;&sup2;u/&part;x&sup2;</span></h3>
            <canvas id="pinnChart"></canvas>
        </div>
    </div>

    <!-- ═══ ROW 3: WB Pipeline + Events | Request Log ═══ -->
    <div class="g2">
        <div class="card" style="border-color:#1a5a3a">
            <h3 style="color:#4caf50">Write-Back Pipeline</h3>
            <div class="wb-flow" id="wbPipeline">
                <div class="wb-stg"><div class="wb-box a" id="wbS1"><div style="color:#81c784">SET ops</div><div class="wb-v" id="wbV1">0</div><div class="wb-l">incoming</div></div></div>
                <div class="wb-arr on" id="wbA1">&#9654;</div>
                <div class="wb-stg"><div class="wb-box" id="wbS2"><div style="color:#64b5f6">Cache</div><div class="wb-v" id="wbV2">0%</div><div class="wb-l">dirty</div></div></div>
                <div class="wb-arr" id="wbA2">&#9654;</div>
                <div class="wb-stg"><div class="wb-box" id="wbS3"><div style="color:#ffb74d">Queue</div><div class="wb-v" id="wbV3">0</div><div class="wb-l">pending</div></div></div>
                <div class="wb-arr" id="wbA3">&#9654;</div>
                <div class="wb-stg"><div class="wb-box" id="wbS4"><div style="color:#ce93d8">Flush</div><div class="wb-v" id="wbV4">0</div><div class="wb-l">entries/s</div></div></div>
                <div class="wb-arr" id="wbA4">&#9654;</div>
                <div class="wb-stg"><div class="wb-box a" id="wbS5"><div style="color:#4caf50">Disk</div><div class="wb-v" id="wbV5">OK</div><div class="wb-l">persisted</div></div></div>
            </div>
            <div class="wb-divider"></div>
            <div class="wb-ev-title">System Events (PINN + WB + Lock)</div>
            <div class="evlog" id="evLog"></div>
        </div>
        <div class="card">
            <h3>Live Request Log</h3>
            <div class="evlog" id="reqLog" style="max-height:340px"></div>
        </div>
    </div>

</div>

<script>
/* ════════════════════════════════════════════════════════════════
   CONFIG & STATE
   ════════════════════════════════════════════════════════════════ */
const API = 'http://127.0.0.1:8080';
let prevOps=0, prevHits=0, prevMisses=0;
let trafficHistory = [];
const MAX_HIST = 60;
const S = Array.from({length:32},function(_,i){return 'S'+i});

/* ON/OFF toggle state */
var isRunning = true;
var pollInterval = null;

/* Node topology animation state */
var topoPathIndex = 0;
var topoPaths = [
    {x1:65,y1:55,x2:245,y2:39},
    {x1:65,y1:55,x2:425,y2:55},
    {x1:65,y1:55,x2:425,y2:195},
    {x1:65,y1:55,x2:245,y2:218}
];
var topoNodeIds = ['A','B','C','D'];
var dotProgress = 0;
var dotAnimFrame = null;
var topoNodeHeatLevels = ['cold','cold','cold','cold'];

/* ════════════════════════════════════════════════════════════════
   CHARTS
   ════════════════════════════════════════════════════════════════ */
Chart.defaults.color = '#546e7a';
Chart.defaults.borderColor = 'rgba(31,52,96,0.5)';

var trafficChart = new Chart(document.getElementById('trafficChart'),{
    type:'line',
    data:{labels:[],datasets:[
        {label:'Ops/s',  data:[],borderColor:'#00d4ff',backgroundColor:'rgba(0,212,255,.06)',tension:.4,fill:true,pointRadius:0},
        {label:'Hits/s', data:[],borderColor:'#4caf50',backgroundColor:'transparent',tension:.4,borderDash:[4,3],pointRadius:0},
        {label:'Miss/s', data:[],borderColor:'#f44336',backgroundColor:'transparent',tension:.4,borderDash:[4,3],pointRadius:0}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{boxWidth:10,font:{size:10}}}},scales:{y:{beginAtZero:true}}}
});

var pinnChart = new Chart(document.getElementById('pinnChart'),{
    type:'bar',
    data:{labels:S,datasets:[
        {label:'Actual Heat',   data:new Array(32).fill(0),backgroundColor:'rgba(0,212,255,.45)',borderColor:'#00d4ff',borderWidth:1,borderRadius:2},
        {label:'Predicted 10s', data:new Array(32).fill(0),backgroundColor:'rgba(244,67,54,.3)', borderColor:'#f44336',borderWidth:1,borderRadius:2}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{boxWidth:10,font:{size:10}}}},scales:{y:{beginAtZero:true,max:110,grid:{color:'rgba(31,52,96,.35)'}},x:{ticks:{font:{size:7}}}}}
});

/* ════════════════════════════════════════════════════════════════
   INIT MERGED SEGMENT GRID (Heat + Lock)
   ════════════════════════════════════════════════════════════════ */
var sgEl = document.getElementById('segGrid');
var sgHeatClasses = ['sg-cold','sg-warm','sg-hot','sg-stroke'];
var sgLkClasses   = ['sg-lk-free','sg-lk-shared','sg-lk-excl','sg-lk-cont'];
var sgLkNames     = ['FREE','SHARED','EXCL','CONTEND'];
for (var i=0; i<32; i++){
    var d = document.createElement('div');
    d.className = 'sg sg-cold sg-lk-free';
    d.id = 'sg-'+i;
    d.innerHTML = 'S'+i+'<div class="sg-heat">0%</div><div class="sg-lock">FREE</div>';
    sgEl.appendChild(d);
}

/* ════════════════════════════════════════════════════════════════
   NODE TOPOLOGY HELPERS
   ════════════════════════════════════════════════════════════════ */
var nodeColors = {cold:'#1f3460', warm:'#2e7d32', hot:'#e65100', stroke:'#c62828'};
var flowDotColors = {cold:'#00d4ff', warm:'#4caf50', hot:'#ff9800', stroke:'#f44336'};

function getNodeHeatLevel(maxH){
    if(maxH>80) return 'stroke';
    if(maxH>60) return 'hot';
    if(maxH>25) return 'warm';
    return 'cold';
}

function updateNodeTopo(segReq, segHeat, opsPerSec){
    var ranges = [{id:'A',start:0,end:7},{id:'B',start:8,end:15},{id:'C',start:16,end:23},{id:'D',start:24,end:31}];
    for(var n=0; n<ranges.length; n++){
        var r = ranges[n];
        var reqSum=0, maxH=0;
        for(var i=r.start; i<=r.end; i++){
            reqSum += (segReq[i]||0);
            if((segHeat[i]||0) > maxH) maxH = segHeat[i]||0;
        }
        var level = getNodeHeatLevel(maxH);
        topoNodeHeatLevels[n] = level;
        var rect = document.getElementById('topoRect'+r.id);
        rect.setAttribute('stroke', nodeColors[level]);
        if(level==='stroke'){rect.setAttribute('stroke-width','2.5')} else {rect.setAttribute('stroke-width','1.5')}

        var info = document.getElementById('topoInfo'+r.id);
        info.textContent = 'S'+r.start+'-S'+r.end+' | '+reqSum.toLocaleString()+' req';

        // Update flow labels
        var fl = document.getElementById('flowLabel'+r.id);
        if(fl){
            var pct = opsPerSec>0 ? Math.round(reqSum / Math.max(1, segReq.reduce(function(a,b){return a+b},0)) * opsPerSec) : 0;
            fl.textContent = pct + ' req/s';
        }
    }
    // Client label
    document.getElementById('topoLB').textContent = opsPerSec + ' ops/s';
}

/* ════════════════════════════════════════════════════════════════
   NODE TOPOLOGY ANIMATION — one path at a time
   ════════════════════════════════════════════════════════════════ */
function animateFlowDot(){
    if(!isRunning){
        var fd=document.getElementById('flowDot');
        if(fd) fd.setAttribute('opacity','0');
        return;
    }
    var p = topoPaths[topoPathIndex];
    dotProgress += 0.012;
    if(dotProgress >= 1){
        dotProgress = 0;
        // Dim previous path
        document.getElementById('connLine'+topoNodeIds[topoPathIndex]).setAttribute('stroke','#1f3460');
        topoPathIndex = (topoPathIndex + 1) % 4;
        p = topoPaths[topoPathIndex];
    }
    // Highlight active path with heat-appropriate color
    var lvl = topoNodeHeatLevels[topoPathIndex];
    var dotCol = flowDotColors[lvl];
    document.getElementById('connLine'+topoNodeIds[topoPathIndex]).setAttribute('stroke', dotCol);
    var dot = document.getElementById('flowDot');
    dot.setAttribute('cx', p.x1 + (p.x2-p.x1)*dotProgress);
    dot.setAttribute('cy', p.y1 + (p.y2-p.y1)*dotProgress);
    dot.setAttribute('fill', dotCol);
    dot.setAttribute('opacity','0.9');
    dotAnimFrame = requestAnimationFrame(animateFlowDot);
}

/* ════════════════════════════════════════════════════════════════
   BURST CONTROLS (MULTI-SEGMENT)
   ════════════════════════════════════════════════════════════════ */
async function resetDashboard(){
    try{
        await fetch(API+'/burst/stop');
        await fetch(API+'/reset');
        // Reset client-side state
        prevOps=0; prevHits=0; prevMisses=0;
        trafficHistory = [];
        trafficChart.data.labels = [];
        trafficChart.data.datasets[0].data = [];
        trafficChart.data.datasets[1].data = [];
        trafficChart.data.datasets[2].data = [];
        trafficChart.update('none');
        pinnChart.data.datasets[0].data = new Array(32).fill(0);
        pinnChart.data.datasets[1].data = new Array(32).fill(0);
        pinnChart.update('none');
        unifiedEvents.length = 0;
        renderEvents();
        document.getElementById('reqLog').innerHTML = '';
        document.getElementById('burstStatus').textContent = 'Ready';
        document.getElementById('burstStatus').style.color = '#546e7a';
        document.getElementById('strokeAlert').className = 'stroke-alert';
        prevPinnEvents=0; prevWbEvents=0; prevLockEvents=0;
        // Reset segment grid visuals
        for(var i=0;i<32;i++){
            var el=document.getElementById('sg-'+i);
            el.className='sg sg-cold sg-lk-free';
            el.querySelector('.sg-heat').textContent='0%';
            el.querySelector('.sg-lock').textContent='FREE';
        }
        // Reset node topology
        var ids=['A','B','C','D'];
        for(var n=0;n<ids.length;n++){
            document.getElementById('topoRect'+ids[n]).setAttribute('stroke','#1f3460');
            document.getElementById('topoInfo'+ids[n]).textContent='S'+(n*8)+'-S'+(n*8+7)+' | 0 req';
            document.getElementById('flowLabel'+ids[n]).textContent='0 req/s';
            document.getElementById('connLine'+ids[n]).setAttribute('stroke','#1f3460');
        }
        document.getElementById('topoLB').textContent='0 ops/s';
        document.getElementById('flowDot').setAttribute('opacity','0');
        topoNodeHeatLevels = ['cold','cold','cold','cold'];
        topoPathIndex=0; dotProgress=0;
        // Reset KPIs to zero
        document.getElementById('kTotalOps').textContent='0';
        document.getElementById('kOps').textContent='0';
        document.getElementById('kHitRate').textContent='0%';
        document.getElementById('kHits').textContent='0';
        document.getElementById('kMiss').textContent='0';
        document.getElementById('kKeys').textContent='0';
        document.getElementById('kFlushed').textContent='0';
        document.getElementById('kContentions').textContent='0';
        // Reset WB pipeline
        document.getElementById('wbV1').textContent='0';
        document.getElementById('wbV2').textContent='0%';
        document.getElementById('wbV3').textContent='0';
        document.getElementById('wbV4').textContent='0';
        document.getElementById('wbV5').textContent='OK';
        // Reset status bar
        document.getElementById('sbPinn').textContent='Normal';document.getElementById('sbPinn').className='sb-val c-purple';
        document.getElementById('sbLock').textContent='All Free';document.getElementById('sbLock').className='sb-val c-green';
        document.getElementById('sbWB').textContent='Idle';document.getElementById('sbWB').className='sb-val c-green';
        document.getElementById('sbSegs').textContent='32 Active';
    }catch(e){}
}

/* ════════════════════════════════════════════════════════════════
   ON/OFF TOGGLE
   ════════════════════════════════════════════════════════════════ */
function toggleSystem(on){
    isRunning = on;
    if(!on){
        // Stop polling
        if(pollInterval){clearInterval(pollInterval);pollInterval=null}
        // Stop animation
        if(dotAnimFrame){cancelAnimationFrame(dotAnimFrame);dotAnimFrame=null}
        // Reset dashboard to zeros
        resetDashboard();
        // Update UI
        document.getElementById('badge').className='badge off';
        document.getElementById('badgeTxt').textContent='Stopped';
        document.getElementById('sbServer').textContent='PAUSED';
        document.getElementById('sbServer').className='sb-val c-orange';
        document.getElementById('togOn').className='toggle-lbl inactive';
        document.getElementById('togOff').className='toggle-lbl';
        document.getElementById('togOff').style.color='#f44336';
    } else {
        // Resume
        document.getElementById('togOn').className='toggle-lbl active';
        document.getElementById('togOff').className='toggle-lbl inactive';
        document.getElementById('togOff').style.color='';
        pollInterval = setInterval(poll, 1000);
        poll();
        animateFlowDot();
    }
}

async function fireBurst(){
    var segsStr = document.getElementById('burstSegs').value;
    var pow = document.getElementById('burstPow').value;
    var segs = segsStr.split(',').map(function(s){return s.trim()}).filter(function(s){return s!=='' && !isNaN(s)});
    if(segs.length===0) return;
    try{
        await fetch(API+'/burst?seg='+segs.join(',')+('&intensity=')+pow);
        document.getElementById('burstStatus').textContent = 'Burst on '+segs.map(function(s){return 'S'+s}).join(', ');
        document.getElementById('burstStatus').style.color = '#f44336';
    }catch(e){}
}

async function stopBurst(){
    try{await fetch(API+'/burst/stop');
        document.getElementById('burstStatus').textContent='Ready';
        document.getElementById('burstStatus').style.color='#546e7a';
    }catch(e){}
}

/* ════════════════════════════════════════════════════════════════
   UNIFIED EVENT LOG
   ════════════════════════════════════════════════════════════════ */
var unifiedEvents = [];
function pushEvent(type, seg, action, detail){
    var t = new Date().toLocaleTimeString('en-US',{hour12:false});
    unifiedEvents.unshift({type:type,time:t,seg:seg,action:action,detail:detail});
    if(unifiedEvents.length > 60) unifiedEvents.length = 60;
}
function renderEvents(){
    var el = document.getElementById('evLog');
    el.innerHTML = '';
    unifiedEvents.slice(0,30).forEach(function(e){
        var d = document.createElement('div');
        d.className = 'ev ev-' + e.type;
        d.innerHTML = '<span class="ev-t">'+e.time+'</span><span class="ev-s">S'+e.seg+'</span><span class="ev-a">'+e.action+'</span><span class="ev-d">'+e.detail+'</span>';
        el.appendChild(d);
    });
}

/* ════════════════════════════════════════════════════════════════
   REQUEST LOG
   ════════════════════════════════════════════════════════════════ */
function addReqLog(cmd, key, lat, isHit){
    var el = document.getElementById('reqLog');
    var t = new Date().toLocaleTimeString('en-US',{hour12:false});
    var hitTxt = isHit===true?' HIT':isHit===false?' MISS':'';
    var hitCl  = isHit===true?'c-green':isHit===false?'c-orange':'';
    var d = document.createElement('div');
    d.className='ev ev-req';
    d.innerHTML='<span class="ev-t">'+t+'</span><span class="ev-s" style="color:'+(cmd==='SET'?'#4caf50':cmd==='DEL'?'#f44336':'#00d4ff')+'">'+cmd+'</span><span class="ev-a">'+key+'</span>'+(hitTxt?'<span class="'+hitCl+'" style="font-size:.85em">'+hitTxt+'</span>':'')+'<span class="ev-d" style="margin-left:auto">'+lat.toFixed(1)+'ms</span>';
    el.prepend(d);
    while(el.children.length>50) el.removeChild(el.lastChild);
}

/* ════════════════════════════════════════════════════════════════
   MAIN POLL
   ════════════════════════════════════════════════════════════════ */
var prevPinnEvents=0, prevWbEvents=0, prevLockEvents=0;

async function poll(){
    if(!isRunning) return;
    try{
        var r = await fetch(API+'/metrics');
        var d = await r.json();

        // ── Connection badge ──
        document.getElementById('badge').className='badge on';
        document.getElementById('badgeTxt').textContent='Connected';

        // ── KPIs ──
        var ops = d.total_ops||0;
        var dOps = Math.max(0, ops-prevOps); prevOps=ops;
        var hits = d.cache_hits||0, misses=d.cache_misses||0;
        var total = hits+misses;
        var hitRate = total>0 ? (100*hits/total) : 0;
        var dHits = Math.max(0,hits-prevHits), dMiss = Math.max(0,misses-prevMisses);
        prevHits=hits; prevMisses=misses;

        document.getElementById('kTotalOps').textContent = ops.toLocaleString();
        document.getElementById('kOps').textContent = dOps.toLocaleString();
        document.getElementById('kHitRate').textContent = hitRate.toFixed(1)+'%';
        document.getElementById('kHitRate').style.color = hitRate>80?'#4caf50':hitRate>50?'#ff9800':'#f44336';
        document.getElementById('kHits').textContent = hits.toLocaleString();
        document.getElementById('kMiss').textContent = misses.toLocaleString();
        document.getElementById('kKeys').textContent = (d.current_keys||0).toLocaleString();

        // ── Traffic chart ──
        var tl = new Date().toLocaleTimeString('en-US',{hour12:false});
        trafficHistory.push({t:tl,o:dOps,h:dHits,m:dMiss});
        if(trafficHistory.length>MAX_HIST) trafficHistory.shift();
        trafficChart.data.labels = trafficHistory.map(function(x){return x.t});
        trafficChart.data.datasets[0].data = trafficHistory.map(function(x){return x.o});
        trafficChart.data.datasets[1].data = trafficHistory.map(function(x){return x.h});
        trafficChart.data.datasets[2].data = trafficHistory.map(function(x){return x.m});
        trafficChart.update('none');

        // ── Segment data ──
        var segHeat = d.segment_heat || new Array(32).fill(0);
        var segReq  = d.segment_requests || new Array(32).fill(0);

        // ── PINN ──
        var pinn = d.pinn;
        var strokeSegs = (pinn && pinn.stroke_segments) || [];

        // ── Locks ──
        var locks = d.locks;
        var ls = locks ? (locks.state || new Array(32).fill(0)) : new Array(32).fill(0);
        var lw = locks ? (locks.wait_ms || new Array(32).fill(0)) : new Array(32).fill(0);
        var lc = locks ? (locks.contentions || new Array(32).fill(0)) : new Array(32).fill(0);
        var totalCont=0, contSegs=0;

        // ── Merged Segment Grid (Heat + Lock) ──
        for(var i=0; i<32; i++){
            var el = document.getElementById('sg-'+i);
            var h = segHeat[i];
            var isStroke = strokeSegs.indexOf(i) !== -1;
            var heatCl = isStroke ? 'sg-stroke' : (h>80?'sg-stroke':h>60?'sg-hot':h>25?'sg-warm':'sg-cold');
            var lockCl = sgLkClasses[ls[i]] || 'sg-lk-free';
            el.className = 'sg ' + heatCl + ' ' + lockCl;
            el.querySelector('.sg-heat').textContent = Math.round(h)+'%';
            var lockLabel = lw[i] > 0.5 ? lw[i].toFixed(1)+'ms' : sgLkNames[ls[i]];
            el.querySelector('.sg-lock').textContent = lockLabel;
            totalCont += lc[i];
            if(ls[i]===3) contSegs++;
        }

        document.getElementById('kContentions').textContent = totalCont.toLocaleString();

        // ── Node Topology ──
        updateNodeTopo(segReq, segHeat, dOps);

        // ── PINN chart ──
        if(pinn){
            var actual = pinn.u || segHeat;
            var predicted = pinn.predicted || new Array(32).fill(0);
            pinnChart.data.datasets[0].data = actual;
            pinnChart.data.datasets[1].data = predicted;
            pinnChart.data.datasets[1].backgroundColor = predicted.map(function(p){return p>(pinn.threshold||75)?'rgba(244,67,54,.65)':'rgba(244,67,54,.2)'});
            pinnChart.update('none');

            // Stroke alert
            var alertEl = document.getElementById('strokeAlert');
            if(strokeSegs.length>0){
                alertEl.className='stroke-alert active';
                document.getElementById('strokeText').textContent='HEAT STROKE: '+strokeSegs.map(function(s){return 'S'+s}).join(', ');
                var maxP = Math.max.apply(null,strokeSegs.map(function(s){return predicted[s]||0}));
                document.getElementById('strokeDetail').textContent='Predicted '+maxP.toFixed(1)+'% > '+(pinn.threshold||75)+'% threshold | Burgers residual anomaly | WB emergency flush + Lock contention';
            } else { alertEl.className='stroke-alert' }

            // Status bar: PINN
            var sbP = document.getElementById('sbPinn');
            if(strokeSegs.length>0){sbP.textContent='STROKE ('+strokeSegs.length+')';sbP.className='sb-val c-red'}
            else{sbP.textContent='Normal';sbP.className='sb-val c-purple'}

            // PINN events -> unified log
            var pinnEvts = pinn.events || [];
            if(pinnEvts.length > prevPinnEvents){
                for(var pe=prevPinnEvents; pe<pinnEvts.length; pe++){
                    var ev = pinnEvts[pe];
                    pushEvent('pinn', ev.segment, ev.action, ev.detail);
                }
                prevPinnEvents = pinnEvts.length;
            }
        }

        // ── Write-Back ──
        var wb = d.writeback;
        if(wb){
            var qd = wb.queue_depth || new Array(32).fill(0);
            var fr = wb.flush_rate || new Array(32).fill(0);
            var dr = wb.dirty_ratio || new Array(32).fill(0);
            document.getElementById('kFlushed').textContent = (wb.total_flushed||0).toLocaleString();

            // Pipeline vis — focus on hottest segment
            var tSeg = strokeSegs.length>0 ? strokeSegs[0] : 14;
            var tQ=qd[tSeg]||0, tF=fr[tSeg]||0, tD=dr[tSeg]||0, tH=segHeat[tSeg]||0;
            document.getElementById('wbV1').textContent = Math.round(tH*0.15);
            document.getElementById('wbV2').textContent = Math.round(tD)+'%';
            document.getElementById('wbV3').textContent = Math.round(tQ);
            document.getElementById('wbV4').textContent = tF.toFixed(1);
            document.getElementById('wbV5').textContent = tF>10?'BUSY':'OK';
            document.getElementById('wbV5').style.color = tF>10?'#ff9800':'#4caf50';
            document.getElementById('wbS3').className='wb-box'+(tQ>100?' s':tQ>30?' h':tQ>5?' a':'');
            document.getElementById('wbS4').className='wb-box'+(tF>10?' s':tF>5?' h':' a');
            document.getElementById('wbS5').className='wb-box'+(tF>10?' h':' a');
            document.getElementById('wbA1').className='wb-arr'+(tH>5?' on':'');
            document.getElementById('wbA2').className='wb-arr'+(tD>5?' on':'');
            document.getElementById('wbA3').className='wb-arr'+(tQ>3?' on':'');
            document.getElementById('wbA4').className='wb-arr'+(tF>0.5?' on':'');

            // Status bar: WB
            var maxQ = Math.max.apply(null,qd);
            var sbW = document.getElementById('sbWB');
            if(maxQ>100){sbW.textContent='OVERFLOW';sbW.className='sb-val c-red'}
            else if(maxQ>30){sbW.textContent='Busy ('+Math.round(maxQ)+')';sbW.className='sb-val c-orange'}
            else if(maxQ>5){sbW.textContent='Draining';sbW.className='sb-val c-blue'}
            else{sbW.textContent='Idle';sbW.className='sb-val c-green'}

            // WB events -> unified log
            var wbEvts = wb.events || [];
            if(wbEvts.length > prevWbEvents){
                for(var we=prevWbEvents; we<wbEvts.length; we++){
                    var ev = wbEvts[we];
                    pushEvent('wb', ev.seg, ev.type, 'queue='+ev.queue+' flush='+ev.rate+'/s');
                }
                prevWbEvents = wbEvts.length;
            }
        }

        // ── Status bar: Locks ──
        var sbL = document.getElementById('sbLock');
        if(contSegs>0){sbL.textContent='CONTENDED ('+contSegs+')';sbL.className='sb-val c-red'}
        else{
            var exclSegs=0;for(var i=0;i<32;i++){if(ls[i]===2)exclSegs++}
            if(exclSegs>0){sbL.textContent='Excl ('+exclSegs+')';sbL.className='sb-val c-orange'}
            else{sbL.textContent='All Free';sbL.className='sb-val c-green'}
        }

        // Lock events -> unified log
        if(locks){
            var lockEvts = locks.events || [];
            if(lockEvts.length > prevLockEvents){
                for(var le=prevLockEvents; le<lockEvts.length; le++){
                    var ev = lockEvts[le];
                    pushEvent('lock', ev.seg, ev.state, ev.detail);
                }
                prevLockEvents = lockEvts.length;
            }
        }

        // ── Status bar extras ──
        var activeSegs=0;for(var i=0;i<32;i++){if(segHeat[i]>1)activeSegs++}
        document.getElementById('sbSegs').textContent = '32 ('+activeSegs+' hot)';
        document.getElementById('sbMode').textContent = (d.write_back||0)>0?'Write-Back':'Write-Through';
        document.getElementById('sbServer').textContent='ONLINE';document.getElementById('sbServer').className='sb-val c-green';

        // ── Render unified events ──
        renderEvents();

        // ── Request log entries ──
        var cmds=['SET','GET','GET','GET'];
        for(var i=0;i<Math.min(dOps,4);i++){
            var cmd=cmds[Math.floor(Math.random()*cmds.length)];
            var key='key:'+Math.floor(Math.random()*1000);
            var lat=0.3+Math.random()*3.5;
            var isHit=cmd==='GET'?Math.random()<(hitRate/100):null;
            addReqLog(cmd,key,lat,isHit);
        }

    }catch(e){
        document.getElementById('badge').className='badge off';
        document.getElementById('badgeTxt').textContent='Disconnected';
        document.getElementById('sbServer').textContent='OFFLINE';
        document.getElementById('sbServer').className='sb-val c-red';
    }
}

pollInterval = setInterval(poll, 1000);
poll();
animateFlowDot();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Distributed Cache System ‚Äî Live Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#0a0c15;color:#d8dee9;min-height:100vh}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:#111827}
::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
.wrap{max-width:1400px;margin:0 auto;padding:12px 16px}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
header{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;
  background:linear-gradient(135deg,#0e1225,#141e35);border-radius:10px;
  margin-bottom:10px;border:1px solid #1e3050;flex-wrap:wrap;gap:6px}
header h1{font-size:1.1em;font-weight:700;letter-spacing:.3px;white-space:nowrap}
header h1 span{color:#38bdf8}
.hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.badge{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:12px;font-size:.62em;font-weight:600}
.badge.on{background:rgba(56,189,248,.08);color:#38bdf8;border:1px solid rgba(56,189,248,.3)}
.badge.off{background:rgba(251,113,133,.08);color:#fb7185;border:1px solid rgba(251,113,133,.3)}
.dot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* Toggle */
.tog-wrap{display:flex;align-items:center;gap:4px}
.tog-label{font-size:.56em;font-weight:600;color:#475569;transition:color .3s;text-transform:uppercase;letter-spacing:.5px}
.tog-label.on{color:#4ade80}.tog-label.stop{color:#fb7185}
.tog{position:relative;width:32px;height:16px;display:inline-block}
.tog input{opacity:0;width:0;height:0}
.tog-track{position:absolute;cursor:pointer;inset:0;background:#fb7185;border-radius:16px;transition:.3s}
.tog-track:before{content:'';position:absolute;width:12px;height:12px;left:2px;bottom:2px;background:#fff;border-radius:50%;transition:.3s}
.tog input:checked+.tog-track{background:#4ade80;box-shadow:0 0 8px rgba(74,222,128,.2)}
.tog input:checked+.tog-track:before{transform:translateX(16px)}

/* Slider */
.slider-wrap{display:flex;align-items:center;gap:4px;background:#111827;border:1px solid #1e3050;border-radius:7px;padding:3px 8px}
.slider-wrap label{font-size:.54em;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap}
.slider-wrap input[type=range]{width:80px;height:3px;-webkit-appearance:none;background:linear-gradient(90deg,#4ade80,#fbbf24,#fb7185);border-radius:2px;outline:none;cursor:pointer}
.slider-wrap input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:#fff;box-shadow:0 0 4px rgba(0,0,0,.4);cursor:grab}
.slider-val{font-size:.64em;font-weight:700;color:#38bdf8;min-width:40px;text-align:right}

/* ‚ïê‚ïê‚ïê STATUS BAR (Row 1) ‚ïê‚ïê‚ïê */
.status-bar{display:grid;grid-template-columns:repeat(6,1fr);gap:7px;margin-bottom:10px}
.stat{text-align:center;background:#111827;border:1px solid #1e3050;border-radius:8px;padding:8px 4px;transition:border-color .3s}
.stat .sv{font-size:1.3em;font-weight:800;line-height:1.1}
.stat .sl{font-size:.5em;color:#64748b;margin-top:2px;text-transform:uppercase;letter-spacing:.5px}
.stat .ss{font-size:.5em;color:#475569;margin-top:1px}

/* ‚ïê‚ïê‚ïê SECTION CARDS ‚ïê‚ïê‚ïê */
.section{background:#111827;border:1px solid #1e3050;border-radius:9px;padding:10px 12px}
.section h3{font-size:.7em;color:#94a3b8;margin-bottom:6px;display:flex;align-items:center;gap:5px;font-weight:600}
.section h3 .icon{font-size:1em}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
canvas{max-height:175px}

/* ‚ïê‚ïê‚ïê BURST BAR ‚ïê‚ïê‚ïê */
.burst-bar{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:8px 14px;
  background:linear-gradient(135deg,#1a0e0e,#1e1028);border:1px solid #3b1050;border-radius:9px;flex-wrap:wrap}
.burst-bar label{font-size:.6em;color:#a78bfa;font-weight:700;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}
.burst-bar input[type=text]{background:#0f172a;border:1px solid #334155;color:#d8dee9;border-radius:5px;padding:4px 8px;font-size:.7em;font-family:inherit;width:180px}
.burst-bar input[type=number]{background:#0f172a;border:1px solid #334155;color:#d8dee9;border-radius:5px;padding:4px 6px;font-size:.7em;font-family:inherit;width:70px}
.burst-bar input::placeholder{color:#475569}
.btn{border:none;font-weight:700;padding:5px 14px;border-radius:6px;cursor:pointer;font-size:.66em;letter-spacing:.3px;transition:all .2s;text-transform:uppercase}
.btn:hover{transform:scale(1.03)}.btn:active{transform:scale(.97)}
.btn-burst{background:linear-gradient(135deg,#dc2626,#f87171);color:#fff}
.btn-burst:hover{box-shadow:0 0 12px rgba(248,113,113,.3)}
.btn-stop{background:linear-gradient(135deg,#334155,#64748b);color:#fff}
.btn-stop.active{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#0f172a;box-shadow:0 0 10px rgba(251,191,36,.3)}
.burst-status{font-size:.6em;margin-left:auto;font-weight:600;display:flex;align-items:center;gap:4px}
.burst-dot{width:6px;height:6px;border-radius:50%;display:inline-block}

/* ‚ïê‚ïê‚ïê CONTROL BAR ‚ïê‚ïê‚ïê */
.ctrl-bar{display:flex;align-items:center;gap:6px;margin-bottom:10px;padding:7px 14px;
  background:#111827;border:1px solid #1e3050;border-radius:9px;flex-wrap:wrap}
.ctrl-bar .ctrl-title{font-size:.58em;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-right:4px;white-space:nowrap}
.btn-ctrl{background:#0f172a;border:1px solid #334155;color:#94a3b8;font-weight:600;padding:4px 10px;
  border-radius:5px;cursor:pointer;font-size:.6em;transition:all .2s;white-space:nowrap}
.btn-ctrl:hover{background:#1e293b;border-color:#475569;color:#d8dee9}
.btn-ctrl.running{border-color:#4ade80;color:#4ade80;background:rgba(74,222,128,.06)}
.ctrl-status{font-size:.52em;color:#475569;margin-left:2px}

/* ‚ïê‚ïê‚ïê SEGMENT GRID 8x4 ‚ïê‚ïê‚ïê */
.seg-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
.seg-cell{position:relative;border-radius:5px;background:#1e293b;border:1px solid #334155;
  padding:5px 3px;text-align:center;transition:all .4s;cursor:default;min-height:44px}
.seg-cell .seg-id{font-weight:700;color:#94a3b8;font-size:.62em;display:block}
.seg-cell .seg-heat{font-size:.82em;font-weight:800;display:block;margin-top:1px}
.seg-cell .seg-lock{position:absolute;top:1px;right:3px;font-size:.5em;color:#fbbf24;opacity:0;transition:opacity .3s}
.seg-cell .seg-lock.show{opacity:1}
.seg-cell.hot{background:linear-gradient(135deg,#7f1d1d,#dc2626);border-color:#f87171;box-shadow:0 0 8px rgba(248,113,113,.25)}
.seg-cell.hot .seg-heat{color:#fecaca}
.seg-cell.warm{background:linear-gradient(135deg,#78350f,#b45309);border-color:#f59e0b;box-shadow:0 0 5px rgba(245,158,11,.15)}
.seg-cell.warm .seg-heat{color:#fef3c7}
.seg-cell.cool{background:linear-gradient(135deg,#0c4a6e,#0369a1);border-color:#38bdf8}
.seg-cell.cool .seg-heat{color:#bae6fd}
.seg-cell.cold{background:#1e293b;border-color:#334155}
.seg-cell.cold .seg-heat{color:#64748b}

/* ‚ïê‚ïê‚ïê STROKE ALERT ‚ïê‚ïê‚ïê */
.stroke-alert{display:none;margin-bottom:10px;padding:7px 14px;background:rgba(220,38,38,.12);border:1px solid rgba(248,113,133,.3);
  border-radius:8px;color:#fca5a5;font-size:.68em;font-weight:600;align-items:center;gap:8px;animation:alertFlash 1.5s infinite}
.stroke-alert.show{display:flex}
@keyframes alertFlash{0%,100%{border-color:rgba(248,113,133,.3)}50%{border-color:rgba(248,113,133,.8)}}

/* ‚ïê‚ïê‚ïê TOPOLOGY ‚ïê‚ïê‚ïê */
.topo-svg{width:100%;height:auto}
.topo-svg text{font-family:'Segoe UI',sans-serif}
.raft-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:6px}
.rm-item{text-align:center;background:#0f172a;border:1px solid #1e3050;border-radius:5px;padding:3px 4px}
.rm-item .rm-val{font-size:.82em;font-weight:700}
.rm-item .rm-lbl{font-size:.46em;color:#64748b;text-transform:uppercase;margin-top:1px}

/* ‚ïê‚ïê‚ïê LSM PIPELINE ‚ïê‚ïê‚ïê */
.pipeline{display:flex;align-items:center;gap:0;padding:4px 0;overflow-x:auto}
.pipe-stage{text-align:center;flex:0 0 auto}
.pipe-box{width:72px;padding:5px 3px;border-radius:6px;border:2px solid #1e3050;background:#0f172a;font-size:.58em;font-weight:600;transition:.3s;position:relative}
.pipe-box.active{border-color:#4ade80;box-shadow:0 0 6px rgba(74,222,128,.08)}
.pipe-box.warn{border-color:#fbbf24;box-shadow:0 0 6px rgba(251,191,36,.08)}
.pipe-box.flush{border-color:#f87171;box-shadow:0 0 10px rgba(248,113,113,.15);animation:flushGlow 1s ease-out}
@keyframes flushGlow{0%{box-shadow:0 0 18px rgba(248,113,113,.4)}100%{box-shadow:0 0 10px rgba(248,113,113,.15)}}
.pipe-box .pipe-title{margin-bottom:2px}
.pipe-box .pipe-val{font-size:1.1em;font-weight:800;margin:1px 0}
.pipe-box .pipe-sub{font-size:.52em;color:#64748b}
.pipe-arrow{flex:0 0 16px;text-align:center;font-size:.7em;color:#1e3050;transition:color .3s}
.pipe-arrow.on{color:#4ade80;animation:arrowPulse 1.2s infinite}
.pipe-arrow.flush-on{color:#f87171;animation:arrowPulse .6s infinite}
@keyframes arrowPulse{0%,100%{opacity:.3}50%{opacity:1}}

/* ‚ïê‚ïê‚ïê PINN CHART ‚ïê‚ïê‚ïê */
.pinn-row{display:flex;gap:10px;margin-top:6px}
.pinn-stat{font-size:.5em;color:#64748b;display:flex;align-items:center;gap:3px}
.pinn-stat strong{color:#a78bfa}

/* ‚ïê‚ïê‚ïê SYSTEM LOG ‚ïê‚ïê‚ïê */
.sys-log{flex:1;min-height:40px;overflow-y:auto;background:#0a0c15;border:1px solid #1e3050;
  border-radius:5px;padding:6px 8px;margin-top:8px;font-family:'Cascadia Code','Consolas',monospace;font-size:.54em;line-height:1.7}
.sys-log div{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ‚ïê‚ïê‚ïê COLORS ‚ïê‚ïê‚ïê */
.c-sky{color:#38bdf8}.c-green{color:#4ade80}.c-amber{color:#fbbf24}.c-rose{color:#fb7185}
.c-purple{color:#a78bfa}.c-slate{color:#64748b}.c-emerald{color:#34d399}.c-blue{color:#60a5fa}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:1100px){.row2{grid-template-columns:1fr}.status-bar{grid-template-columns:repeat(3,1fr)}}
@media(max-width:700px){.status-bar{grid-template-columns:repeat(2,1fr)}.seg-grid{grid-template-columns:repeat(4,1fr)}}
</style>
</head>
<body>
<div class="wrap">

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header>
    <h1>‚ö° Distributed <span>Cache</span> System</h1>
    <div class="hdr-right">
        <div class="badge on" id="badge"><div class="dot"></div><span id="badgeTxt">Connected</span></div>
        <div class="slider-wrap">
            <label>Traffic</label>
            <input type="range" id="speedSlider" min="0" max="12000" value="0" step="50"
                   oninput="onSliderInput(this.value)" onchange="onSliderChange(this.value)">
            <div class="slider-val" id="speedVal">0 ops/s</div>
        </div>
        <div class="tog-wrap">
            <span class="tog-label" id="lblOff" style="color:#475569">OFF</span>
            <label class="tog">
                <input type="checkbox" id="togInput" checked onchange="toggleSystem(this.checked)">
                <span class="tog-track"></span>
            </label>
            <span class="tog-label on" id="lblOn">ON</span>
        </div>
    </div>
</header>

<!-- ‚ïê‚ïê‚ïê STROKE ALERT ‚ïê‚ïê‚ïê -->
<div class="stroke-alert" id="strokeAlert">
    <span>üî•</span>
    <span id="strokeMsg">HEAT STROKE ‚Äî Segments overloaded!</span>
</div>

<!-- ‚ïê‚ïê‚ïê ROW 1: Live Key Metrics (6 cards) ‚ïê‚ïê‚ïê -->
<div class="status-bar">
    <div class="stat">
        <div class="sv c-sky" id="sOps">0</div>
        <div class="sl">Ops / Second</div>
        <div class="ss">Total: <span id="sTotalOps">0</span></div>
    </div>
    <div class="stat">
        <div class="sv c-amber" id="sHitRate">0%</div>
        <div class="sl">Cache Hit Rate</div>
        <div class="ss"><span class="c-green" id="sHits">0</span> hits ¬∑ <span class="c-rose" id="sMiss">0</span> miss</div>
    </div>
    <div class="stat">
        <div class="sv c-emerald" id="sKeys">0</div>
        <div class="sl">Active Keys</div>
        <div class="ss" id="sMode">write-back</div>
    </div>
    <div class="stat">
        <div class="sv c-rose" id="sFlush">0 / <span id="sStroke">0</span></div>
        <div class="sl">Flush / Stroke</div>
        <div class="ss">Recovery events</div>
    </div>
    <div class="stat">
        <div class="sv c-purple" id="sRaftRole">‚Äî</div>
        <div class="sl">Raft Leader</div>
        <div class="ss">Term: <span id="sRaftTerm">0</span></div>
    </div>
    <div class="stat">
        <div class="sv c-blue" id="sPinnSteps">0</div>
        <div class="sl">PINN Steps</div>
        <div class="ss">Loss: <span id="sPinnLoss">‚Äî</span></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê PINN BURST TRIGGER BAR ‚ïê‚ïê‚ïê -->
<div class="burst-bar">
    <label>‚ö° PINN Burst</label>
    <input type="text" id="burstInput" placeholder="Segments: 0,1,2,3" title="Enter shard numbers separated by commas">
    <label style="font-size:.55em;color:#64748b">Intensity</label>
    <input type="number" id="burstIntensity" value="500" min="50" max="5000" step="50">
    <button class="btn btn-burst" onclick="startBurst()">üî• BURST</button>
    <button class="btn btn-stop" id="btnStop" onclick="stopBurst()">‚èπ STOP</button>
    <div class="burst-status" id="burstStatus">
        <span class="burst-dot" id="burstDot" style="background:#475569"></span>
        <span id="burstStatusTxt">Idle</span>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê CONTROL BAR ‚Äî Manual Triggers ‚ïê‚ïê‚ïê -->
<div class="ctrl-bar">
    <span class="ctrl-title">‚öô Controls</span>
    <button class="btn-ctrl" id="ctrlTraffic" onclick="ctrlToggleTraffic()">‚ñ∂ Start Traffic</button>
    <button class="btn-ctrl" onclick="ctrlFlush()">üíæ Flush to Disk</button>
    <button class="btn-ctrl" onclick="ctrlElection()">üó≥ Force Election</button>
    <button class="btn-ctrl" onclick="ctrlCompact()">üóú Compact LSM</button>
    <button class="btn-ctrl" onclick="ctrlReset()">üîÑ Reset All</button>
    <span class="ctrl-status" id="ctrlFeedback"></span>
</div>

<!-- ‚ïê‚ïê‚ïê ROW 2: Segment Grid + Traffic Chart ‚ïê‚ïê‚ïê -->
<div class="row2">
    <!-- Segment Grid 8x4 -->
    <div class="section">
        <h3><span class="icon">üî≤</span> Segment Grid ‚Äî 32 Shards Heat Map
            <span style="margin-left:auto;display:flex;gap:5px;font-size:.78em">
                <span style="display:flex;align-items:center;gap:2px"><span style="width:7px;height:7px;border-radius:2px;background:linear-gradient(135deg,#7f1d1d,#dc2626)"></span><span style="color:#64748b;font-size:.8em">Hot</span></span>
                <span style="display:flex;align-items:center;gap:2px"><span style="width:7px;height:7px;border-radius:2px;background:linear-gradient(135deg,#78350f,#b45309)"></span><span style="color:#64748b;font-size:.8em">Warm</span></span>
                <span style="display:flex;align-items:center;gap:2px"><span style="width:7px;height:7px;border-radius:2px;background:linear-gradient(135deg,#0c4a6e,#0369a1)"></span><span style="color:#64748b;font-size:.8em">Cool</span></span>
                <span style="display:flex;align-items:center;gap:2px"><span style="width:7px;height:7px;border-radius:2px;background:#1e293b"></span><span style="color:#64748b;font-size:.8em">Idle</span></span>
            </span>
        </h3>
        <div class="seg-grid" id="segGrid"></div>
    </div>

    <!-- Traffic + PINN Charts -->
    <div class="section">
        <h3><span class="icon">üìà</span> Traffic Over Time</h3>
        <canvas id="trafficChart" style="max-height:140px"></canvas>
        <h3 style="margin-top:8px"><span class="icon">üß†</span> PINN Shard Prediction
            <span style="margin-left:auto;font-family:'Cambria Math',serif;font-size:.72em;color:#a78bfa;
            background:rgba(167,139,250,.06);padding:1px 5px;border-radius:3px;border:1px solid rgba(167,139,250,.12)">
            ‚àÇu/‚àÇt + u¬∑‚àÇu/‚àÇx = ŒΩ¬∑‚àÇ¬≤u/‚àÇx¬≤</span>
        </h3>
        <canvas id="pinnChart" style="max-height:120px"></canvas>
        <div class="pinn-row">
            <span class="pinn-stat">Steps: <strong id="pinnSteps2">0</strong></span>
            <span class="pinn-stat">Loss: <strong id="pinnLoss2">‚Äî</strong></span>
            <span class="pinn-stat">Params: <strong id="pinnParams2">0</strong></span>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê ROW 3: Network Topology + LSM Pipeline ‚ïê‚ïê‚ïê -->
<div class="row2">
    <!-- Raft Network Topology (5-node cluster) -->
    <div class="section" style="border-color:#312e81">
        <h3><span class="icon">üåê</span> Raft Consensus ‚Äî 5-Node Cluster</h3>
        <div class="topo-wrap">
            <svg viewBox="0 0 550 320" class="topo-svg" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <marker id="arrowG" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                        <path d="M0,0 L6,2 L0,4" fill="#4ade80" opacity=".7"/>
                    </marker>
                    <marker id="arrowY" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                        <path d="M0,0 L6,2 L0,4" fill="#fbbf24" opacity=".7"/>
                    </marker>
                    <radialGradient id="gClient" cx="50%" cy="40%" r="55%">
                        <stop offset="0%" stop-color="#fbbf24" stop-opacity=".35"/>
                        <stop offset="100%" stop-color="#b45309" stop-opacity=".18"/>
                    </radialGradient>
                    <radialGradient id="gLeader" cx="50%" cy="40%" r="55%">
                        <stop offset="0%" stop-color="#4ade80" stop-opacity=".3"/>
                        <stop offset="100%" stop-color="#166534" stop-opacity=".15"/>
                    </radialGradient>
                    <radialGradient id="gFollower" cx="50%" cy="40%" r="55%">
                        <stop offset="0%" stop-color="#38bdf8" stop-opacity=".2"/>
                        <stop offset="100%" stop-color="#0c4a6e" stop-opacity=".12"/>
                    </radialGradient>
                </defs>
                <text x="275" y="14" text-anchor="middle" fill="#475569" font-size="7" font-weight="600" id="phaseLabel">IDLE</text>

                <!-- Connection lines (endpoints updated dynamically by JS) -->
                <line x1="110" y1="70" x2="280" y2="55" stroke="rgba(251,191,36,.2)" stroke-width="1.5" stroke-dasharray="6,4" id="lineClient"/>
                <line x1="280" y1="55" x2="460" y2="130" stroke="#1e3050" stroke-width="1.2" stroke-dasharray="4,3" id="lineRep1" marker-end="url(#arrowG)"/>
                <line x1="280" y1="55" x2="400" y2="260" stroke="#1e3050" stroke-width="1.2" stroke-dasharray="4,3" id="lineRep2" marker-end="url(#arrowG)"/>
                <line x1="280" y1="55" x2="280" y2="280" stroke="#1e3050" stroke-width="1.2" stroke-dasharray="4,3" id="lineRep3" marker-end="url(#arrowG)"/>
                <line x1="280" y1="55" x2="110" y2="240" stroke="#1e3050" stroke-width="1.2" stroke-dasharray="4,3" id="lineRep4" marker-end="url(#arrowG)"/>

                <!-- Ring connecting follower nodes (decorative) -->
                <ellipse cx="295" cy="180" rx="180" ry="110" fill="none" stroke="#1e3050" stroke-width="0.8" stroke-dasharray="3,5" opacity=".4"/>

                <!-- Packet animation groups -->
                <g id="pktsClient"></g><g id="pktsRep1"></g><g id="pktsRep2"></g><g id="pktsRep3"></g><g id="pktsRep4"></g>

                <!-- Client node (top-left ‚Äî solid bright yellow background) -->
                <circle cx="75" cy="60" r="34" fill="#fbbf24" stroke="#92400e" stroke-width="2.5"/>
                <text x="75" y="52" text-anchor="middle" fill="#000" font-size="9" font-weight="700">Client</text>
                <text x="75" y="64" text-anchor="middle" fill="#000" font-size="6" id="topoOps">0 ops/s</text>
                <text x="75" y="74" text-anchor="middle" fill="#000" font-size="5">SET / GET ‚Üí</text>

                <!-- Node 0 (upper-right ‚Äî default leader, solid green) -->
                <circle cx="430" cy="65" r="38" fill="#4ade80" stroke="#166534" stroke-width="2.5" id="nodeBox0"/>
                <text x="430" y="50" text-anchor="middle" fill="#000" font-size="8" font-weight="700">Node 0</text>
                <text x="430" y="62" text-anchor="middle" fill="#000" font-size="7" font-weight="800" id="role0">LEADER</text>
                <text x="430" y="72" text-anchor="middle" fill="#000" font-size="5">S0‚ÄìS6</text>
                <text x="430" y="84" text-anchor="middle" fill="#000" font-size="5.5" font-weight="600" id="req0">0 req</text>

                <!-- Node 1 (right ‚Äî solid green) -->
                <circle cx="490" cy="185" r="34" fill="#4ade80" stroke="#166534" stroke-width="2" id="nodeBox1"/>
                <text x="490" y="178" text-anchor="middle" fill="#000" font-size="8" font-weight="700">Node 1</text>
                <text x="490" y="189" text-anchor="middle" fill="#000" font-size="6.5" font-weight="600" id="role1">Follower</text>
                <text x="490" y="199" text-anchor="middle" fill="#000" font-size="5">S7‚ÄìS12</text>
                <text x="490" y="209" text-anchor="middle" fill="#000" font-size="5" font-weight="600" id="req1">0 req</text>

                <!-- Node 2 (lower-right ‚Äî solid green) -->
                <circle cx="400" cy="275" r="34" fill="#4ade80" stroke="#166534" stroke-width="2" id="nodeBox2"/>
                <text x="400" y="268" text-anchor="middle" fill="#000" font-size="8" font-weight="700">Node 2</text>
                <text x="400" y="279" text-anchor="middle" fill="#000" font-size="6.5" font-weight="600" id="role2">Follower</text>
                <text x="400" y="289" text-anchor="middle" fill="#000" font-size="5">S13‚ÄìS18</text>
                <text x="400" y="299" text-anchor="middle" fill="#000" font-size="5" font-weight="600" id="req2">0 req</text>

                <!-- Node 3 (bottom-center ‚Äî solid green) -->
                <circle cx="210" cy="280" r="34" fill="#4ade80" stroke="#166534" stroke-width="2" id="nodeBox3"/>
                <text x="210" y="273" text-anchor="middle" fill="#000" font-size="8" font-weight="700">Node 3</text>
                <text x="210" y="284" text-anchor="middle" fill="#000" font-size="6.5" font-weight="600" id="role3">Follower</text>
                <text x="210" y="294" text-anchor="middle" fill="#000" font-size="5">S19‚ÄìS24</text>
                <text x="210" y="304" text-anchor="middle" fill="#000" font-size="5" font-weight="600" id="req3">0 req</text>

                <!-- Node 4 (bottom-left ‚Äî solid green) -->
                <circle cx="100" cy="200" r="34" fill="#4ade80" stroke="#166534" stroke-width="2" id="nodeBox4"/>
                <text x="100" y="193" text-anchor="middle" fill="#000" font-size="8" font-weight="700">Node 4</text>
                <text x="100" y="204" text-anchor="middle" fill="#000" font-size="6.5" font-weight="600" id="role4">Follower</text>
                <text x="100" y="214" text-anchor="middle" fill="#000" font-size="5">S25‚ÄìS31</text>
                <text x="100" y="224" text-anchor="middle" fill="#000" font-size="5" font-weight="600" id="req4">0 req</text>

                <text x="330" y="145" text-anchor="start" fill="#4ade80" font-size="5.5" font-style="italic" opacity=".5" id="repLabel">replicating log ‚Üí</text>
                <text x="275" y="310" text-anchor="middle" fill="#a78bfa" font-size="7.5" font-weight="600" id="electionTxt" opacity="0"></text>
            </svg>
        </div>
        <div class="raft-metrics">
            <div class="rm-item"><div class="rm-val c-green" id="riRole">‚Äî</div><div class="rm-lbl">Leader Node</div></div>
            <div class="rm-item"><div class="rm-val c-sky" id="riTerm">0</div><div class="rm-lbl">Term</div></div>
            <div class="rm-item"><div class="rm-val c-amber" id="riCommit">0</div><div class="rm-lbl">Committed</div></div>
            <div class="rm-item"><div class="rm-val c-purple" id="riLog">0</div><div class="rm-lbl">Log Size</div></div>
            <div class="rm-item"><div class="rm-val c-rose" id="riLeader">‚Äî</div><div class="rm-lbl">Leader ID</div></div>
            <div class="rm-item"><div class="rm-val c-emerald" id="riApplied">0</div><div class="rm-lbl">Applied</div></div>
        </div>
    </div>

    <!-- LSM-Tree Pipeline + System Logs -->
    <div class="section" style="border-color:#064e3b;display:flex;flex-direction:column">
        <h3><span class="icon">üóÑÔ∏è</span> LSM-Tree Storage Pipeline
            <span style="margin-left:auto;font-size:.78em;color:#64748b" id="lsmMode">write-back</span>
        </h3>
        <div class="pipeline">
            <div class="pipe-stage">
                <div class="pipe-box active" id="pWAL"><div class="pipe-title c-green">WAL</div><div class="pipe-val" id="pWALv">0 B</div><div class="pipe-sub">write-ahead</div></div>
            </div>
            <div class="pipe-arrow on" id="pA1">&#9654;</div>
            <div class="pipe-stage">
                <div class="pipe-box" id="pMem"><div class="pipe-title c-sky">MemTbl</div><div class="pipe-val" id="pMemV">0</div><div class="pipe-sub">entries</div></div>
            </div>
            <div class="pipe-arrow" id="pA2">&#9654;</div>
            <div class="pipe-stage">
                <div class="pipe-box" id="pSST"><div class="pipe-title c-amber">L0 SST</div><div class="pipe-val" id="pSSTv">0</div><div class="pipe-sub">tables</div></div>
            </div>
            <div class="pipe-arrow" id="pA3">&#9654;</div>
            <div class="pipe-stage">
                <div class="pipe-box" id="pComp"><div class="pipe-title c-purple">Compact</div><div class="pipe-val" id="pCompV">0</div><div class="pipe-sub">done</div></div>
            </div>
            <div class="pipe-arrow" id="pA4">&#9654;</div>
            <div class="pipe-stage">
                <div class="pipe-box" id="pBloom"><div class="pipe-title c-emerald">Bloom</div><div class="pipe-val" id="pBloomV">0</div><div class="pipe-sub">filter hits</div></div>
            </div>
            <div class="pipe-arrow" id="pA5">&#9654;</div>
            <div class="pipe-stage">
                <div class="pipe-box" id="pDB"><div class="pipe-title c-rose">Flush</div><div class="pipe-val" id="pDBv">0</div><div class="pipe-sub">to disk</div></div>
            </div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:4px">
            <div class="rm-item"><div class="rm-val c-green" id="lsmPuts">0</div><div class="rm-lbl">Total Puts</div></div>
            <div class="rm-item"><div class="rm-val c-sky" id="lsmGets">0</div><div class="rm-lbl">Total Gets</div></div>
            <div class="rm-item"><div class="rm-val c-rose" id="lsmDels">0</div><div class="rm-lbl">Total Deletes</div></div>
        </div>
        <!-- System Logs -->
        <h3 style="margin-top:10px"><span class="icon">üìã</span> System Logs</h3>
        <div class="sys-log" id="sysLogWrap">
            <div id="sysLogContent"><div style="color:#475569">[SYSTEM] Waiting for events...</div></div>
        </div>
    </div>
</div>

</div><!-- /wrap -->

<script>
/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
var API = window.location.origin || 'http://127.0.0.1:8080';
var isRunning = true;
var pollTimer = null;
var prevOps=0, prevHits=0, prevMisses=0, prevFlush=0;
var prevNodeReqs=[0,0,0,0,0];
var prevSegLocks = new Array(32).fill(0);
var trafficHistory=[];
var MAX_HIST=60;
var prevRaftLeader=-1;
var nodeReqRates=[0,0,0,0,0];
var pendingRate = null;
var burstActive = false;
var trafficOn = false;

/* 5-node topology positions (centers ‚Äî circular layout) */
var nodeCenters = [
    {x:430, y:65},    /* Node 0: upper-right (default leader) */
    {x:490, y:185},   /* Node 1: right */
    {x:400, y:275},   /* Node 2: lower-right */
    {x:210, y:280},   /* Node 3: bottom-center */
    {x:100, y:200}    /* Node 4: bottom-left */
];
var clientCenter = {x:75, y:60};
var nodeRadii = [38, 34, 34, 34, 34];
var clientRadius = 34;

/* Topology animation */
var animId = null;
var clientPkts = [];
var repPkts = [[],[],[],[]];
var currentLeaderId = 0;

/* ‚ïê‚ïê‚ïê INIT 8x4 SEGMENT GRID ‚ïê‚ïê‚ïê */
(function(){
    var grid = document.getElementById('segGrid');
    for(var i=0; i<32; i++){
        var cell = document.createElement('div');
        cell.className='seg-cell cold';
        cell.id='seg'+i;
        cell.innerHTML='<span class="seg-id">S'+i+'</span>'
            +'<span class="seg-heat">0%</span>'
            +'<span class="seg-lock" id="lock'+i+'">üîí</span>';
        grid.appendChild(cell);
    }
})();

/* ‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê */
Chart.defaults.color='#64748b';
Chart.defaults.borderColor='rgba(30,48,80,0.4)';

var trafficChart = new Chart(document.getElementById('trafficChart'),{
    type:'line',
    data:{labels:[],datasets:[
        {label:'Ops/s',data:[],borderColor:'#38bdf8',backgroundColor:'rgba(56,189,248,.05)',tension:.4,fill:true,pointRadius:0,borderWidth:2},
        {label:'Hits/s',data:[],borderColor:'#4ade80',backgroundColor:'transparent',tension:.4,borderDash:[4,3],pointRadius:0,borderWidth:1.5},
        {label:'Miss/s',data:[],borderColor:'#fb7185',backgroundColor:'transparent',tension:.4,borderDash:[4,3],pointRadius:0,borderWidth:1.5}
    ]},
    options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{labels:{boxWidth:8,font:{size:8}}}},
        scales:{y:{beginAtZero:true,grid:{color:'rgba(30,48,80,.3)'}},
                x:{ticks:{font:{size:5},maxRotation:0}}}}
});

var pinnChart = new Chart(document.getElementById('pinnChart'),{
    type:'bar',
    data:{labels:Array.from({length:32},function(_,i){return 'S'+i}),datasets:[
        {label:'PINN Predicted Heat',data:new Array(32).fill(0),backgroundColor:'rgba(167,139,250,.35)',
         borderColor:'#a78bfa',borderWidth:1,borderRadius:2}
    ]},
    options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{labels:{boxWidth:8,font:{size:8}}}},
        scales:{y:{beginAtZero:true,max:100,grid:{color:'rgba(30,48,80,.3)'},
                   ticks:{callback:function(v){return v+'%'}}},
                x:{ticks:{font:{size:4}}}}}
});

/* ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê */
function fmt(n){if(typeof n!=='number')n=Number(n)||0;return n.toLocaleString();}
function fmtBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function fmtK(n){if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n.toString();}

/* ‚ïê‚ïê‚ïê TRAFFIC SLIDER ‚ïê‚ïê‚ïê */
function onSliderInput(val){
    val=parseInt(val)||0;
    document.getElementById('speedVal').textContent=val+' ops/s';
    pendingRate=val;
}
function onSliderChange(val){
    val=parseInt(val)||0;
    document.getElementById('speedVal').textContent=val+' ops/s';
    sendTrafficRate(val);
}
function sendTrafficRate(val){
    pendingRate=null;
    fetch(API+'/api/traffic',{method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({rate:val})}).catch(function(){});
    trafficOn = (val > 0);
    var btn = document.getElementById('ctrlTraffic');
    if(trafficOn){btn.textContent='‚èπ Stop Traffic';btn.className='btn-ctrl running';}
    else{btn.textContent='‚ñ∂ Start Traffic';btn.className='btn-ctrl';}
}
setInterval(function(){if(pendingRate!==null) sendTrafficRate(pendingRate);},500);

/* ‚ïê‚ïê‚ïê PERSISTENT BURST ‚ïê‚ïê‚ïê */
function startBurst(){
    var input = document.getElementById('burstInput').value.trim();
    var shards = [];
    if(input){
        input.split(',').forEach(function(s){
            var n=parseInt(s.trim());
            if(!isNaN(n)&&n>=0&&n<32) shards.push(n);
        });
    }
    if(shards.length===0) shards=[0,1,2,3];
    var intensity=parseInt(document.getElementById('burstIntensity').value)||500;

    document.getElementById('burstStatusTxt').textContent='Starting...';
    document.getElementById('burstDot').style.background='#fbbf24';

    fetch(API+'/api/burst',{method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({shards:shards,intensity:intensity})
    }).then(function(r){return r.json();}).then(function(d){
        if(d.status==='started'){
            burstActive=true;
            document.getElementById('burstStatusTxt').textContent='BURSTING ['+shards.join(',')+'] @ '+intensity;
            document.getElementById('burstDot').style.background='#f87171';
            document.getElementById('btnStop').className='btn btn-stop active';
        } else {
            document.getElementById('burstStatusTxt').textContent=d.msg||'Already running';
            document.getElementById('burstDot').style.background='#fbbf24';
        }
    }).catch(function(){
        document.getElementById('burstStatusTxt').textContent='Error';
        document.getElementById('burstDot').style.background='#fb7185';
    });
}
function stopBurst(){
    fetch(API+'/api/burst-stop',{method:'POST',
        headers:{'Content-Type':'application/json'},body:'{}'
    }).then(function(r){return r.json();}).then(function(d){
        burstActive=false;
        var msg='Stopped ('+fmtK(d.total_ops||0)+' ops, '+d.hot_detected+' hot)';
        if(d.hot_detected>=3) msg+=' ‚Äî HEAT STROKE!';
        document.getElementById('burstStatusTxt').textContent=msg;
        document.getElementById('burstDot').style.background='#475569';
        document.getElementById('btnStop').className='btn btn-stop';
    }).catch(function(){
        document.getElementById('burstStatusTxt').textContent='Error stopping';
    });
}

/* ‚ïê‚ïê‚ïê CONTROL BAR HANDLERS ‚ïê‚ïê‚ïê */
function showFeedback(msg,color){
    var el=document.getElementById('ctrlFeedback');
    el.textContent=msg;el.style.color=color||'#4ade80';
    setTimeout(function(){el.textContent='';},3000);
}
function ctrlToggleTraffic(){
    if(trafficOn){
        document.getElementById('speedSlider').value=0;
        sendTrafficRate(0);
        showFeedback('Traffic stopped','#fb7185');
    } else {
        var rate=5000;
        document.getElementById('speedSlider').value=rate;
        document.getElementById('speedVal').textContent=rate+' ops/s';
        sendTrafficRate(rate);
        showFeedback('Traffic started at '+rate+' ops/s','#4ade80');
    }
}
function ctrlFlush(){
    fetch(API+'/api/flush',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'})
        .then(function(r){return r.json();}).then(function(d){
            showFeedback('Flushed to disk (count: '+d.flush_count+')','#34d399');
        }).catch(function(){showFeedback('Flush failed','#fb7185');});
}
function ctrlElection(){
    fetch(API+'/api/election',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'})
        .then(function(r){return r.json();}).then(function(d){
            showFeedback('Election: term '+d.old_term+' -> '+d.new_term+' (Leader: Node '+(d.leader_id>=0?d.leader_id:'?')+')','#a78bfa');
        }).catch(function(){showFeedback('Election failed','#fb7185');});
}
function ctrlCompact(){
    fetch(API+'/api/compact',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'})
        .then(function(r){return r.json();}).then(function(d){
            showFeedback('Compacted ('+d.compactions+' done, '+d.sstable_count+' SSTs)','#fbbf24');
        }).catch(function(){showFeedback('Compact failed','#fb7185');});
}

/* ‚ïê‚ïê‚ïê RESET ‚ïê‚ïê‚ïê */
function ctrlReset(){
    try{fetch(API+'/api/reset');}catch(e){}
    resetDashboard();
    showFeedback('Dashboard reset','#38bdf8');
}
function resetDashboard(){
    prevOps=0;prevHits=0;prevMisses=0;prevFlush=0;
    prevNodeReqs=[0,0,0,0,0];nodeReqRates=[0,0,0,0,0];
    prevSegLocks=new Array(32).fill(0);
    trafficHistory=[];
    prevRaftLeader=-1;currentLeaderId=0;
    document.getElementById('sOps').textContent='0';
    document.getElementById('sTotalOps').textContent='0';
    document.getElementById('sHitRate').textContent='0%';
    document.getElementById('sHitRate').style.color='#fbbf24';
    document.getElementById('sHits').textContent='0';
    document.getElementById('sMiss').textContent='0';
    document.getElementById('sKeys').textContent='0';
    document.getElementById('sFlush').innerHTML='0 / <span id="sStroke">0</span>';
    document.getElementById('sRaftRole').textContent='‚Äî';
    document.getElementById('sRaftTerm').textContent='0';
    document.getElementById('sPinnSteps').textContent='0';
    document.getElementById('sPinnLoss').textContent='‚Äî';
    document.getElementById('strokeAlert').className='stroke-alert';
    trafficChart.data.labels=[];
    trafficChart.data.datasets.forEach(function(ds){ds.data=[];});
    trafficChart.update('none');
    pinnChart.data.datasets[0].data=new Array(32).fill(0);
    pinnChart.data.datasets[0].backgroundColor=new Array(32).fill('rgba(167,139,250,.35)');
    pinnChart.update('none');
    for(var i=0;i<32;i++){
        document.getElementById('seg'+i).className='seg-cell cold';
        document.getElementById('seg'+i).querySelector('.seg-heat').textContent='0%';
        document.getElementById('lock'+i).className='seg-lock';
    }
    ['pWAL','pMem','pSST','pComp','pBloom','pDB'].forEach(function(id){document.getElementById(id).className='pipe-box';});
    ['pA1','pA2','pA3','pA4','pA5'].forEach(function(id){document.getElementById(id).className='pipe-arrow';});
    for(var i=0;i<5;i++){
        document.getElementById('role'+i).textContent=i===0?'LEADER':'Follower';
        document.getElementById('role'+i).setAttribute('fill','#000');
        document.getElementById('nodeBox'+i).setAttribute('stroke',i===0?'#166534':'#166534');
        document.getElementById('nodeBox'+i).setAttribute('stroke-width',i===0?'2.5':'2');
        document.getElementById('nodeBox'+i).setAttribute('fill','#4ade80');
        document.getElementById('req'+i).textContent='0 req';
        document.getElementById('req'+i).setAttribute('fill','#000');
    }
    document.getElementById('topoOps').textContent='0 ops/s';
    document.getElementById('electionTxt').setAttribute('opacity','0');
    clientPkts=[];repPkts=[[],[],[],[]];
    updateTopoLines();
    document.getElementById('riRole').textContent='‚Äî';document.getElementById('riTerm').textContent='0';
    document.getElementById('riCommit').textContent='0';document.getElementById('riApplied').textContent='0';
    document.getElementById('riLog').textContent='0';document.getElementById('riLeader').textContent='‚Äî';
    document.getElementById('speedSlider').value=0;document.getElementById('speedVal').textContent='0 ops/s';
    document.getElementById('burstStatusTxt').textContent='Idle';
    document.getElementById('burstDot').style.background='#475569';
    document.getElementById('btnStop').className='btn btn-stop';
    burstActive=false;trafficOn=false;
    document.getElementById('ctrlTraffic').textContent='‚ñ∂ Start Traffic';
    document.getElementById('ctrlTraffic').className='btn-ctrl';
    document.getElementById('lsmPuts').textContent='0';
    document.getElementById('lsmGets').textContent='0';
    document.getElementById('lsmDels').textContent='0';
    document.getElementById('sysLogContent').innerHTML='<div style="color:#475569">[SYSTEM] Dashboard reset</div>';
}

/* ‚ïê‚ïê‚ïê ON/OFF TOGGLE ‚ïê‚ïê‚ïê */
function toggleSystem(on){
    isRunning=on;
    if(!on){
        if(pollTimer){clearInterval(pollTimer);pollTimer=null;}
        if(animId){cancelAnimationFrame(animId);animId=null;}
        sendTrafficRate(0);
        if(burstActive) stopBurst();
        resetDashboard();
        document.getElementById('badge').className='badge off';
        document.getElementById('badgeTxt').textContent='Stopped';
        document.getElementById('lblOn').className='tog-label';
        document.getElementById('lblOn').style.color='#475569';
        document.getElementById('lblOff').className='tog-label stop';
    } else {
        document.getElementById('lblOn').className='tog-label on';
        document.getElementById('lblOn').style.color='';
        document.getElementById('lblOff').className='tog-label';
        document.getElementById('lblOff').style.color='#475569';
        pollTimer=setInterval(poll,1000);
        poll();
        animateTopology();
    }
}

/* ‚ïê‚ïê‚ïê TOPOLOGY: Dynamic leader-based line routing (edge-to-edge) ‚ïê‚ïê‚ïê */
function getLeaderCenter(){ return nodeCenters[currentLeaderId]; }
function getFollowerIds(){ return [0,1,2,3,4].filter(function(i){return i!==currentLeaderId;}); }
function edgePoint(cx, cy, r, tx, ty){
    var dx=tx-cx, dy=ty-cy, len=Math.sqrt(dx*dx+dy*dy);
    if(len<1) return {x:cx,y:cy};
    return {x:cx+r*dx/len, y:cy+r*dy/len};
}

function updateTopoLines(){
    var lc = getLeaderCenter();
    var lr = nodeRadii[currentLeaderId];
    var followers = getFollowerIds();
    /* Client line: edge of client circle to edge of leader circle */
    var cEdge = edgePoint(clientCenter.x, clientCenter.y, clientRadius, lc.x, lc.y);
    var lEdgeC = edgePoint(lc.x, lc.y, lr, clientCenter.x, clientCenter.y);
    document.getElementById('lineClient').setAttribute('x1', cEdge.x);
    document.getElementById('lineClient').setAttribute('y1', cEdge.y);
    document.getElementById('lineClient').setAttribute('x2', lEdgeC.x);
    document.getElementById('lineClient').setAttribute('y2', lEdgeC.y);
    /* Leader to each follower: edge to edge */
    for(var i=0;i<4;i++){
        var fid = followers[i];
        var fr = nodeRadii[fid];
        var fc = nodeCenters[fid];
        var line = document.getElementById('lineRep'+(i+1));
        var lEdge = edgePoint(lc.x, lc.y, lr, fc.x, fc.y);
        var fEdge = edgePoint(fc.x, fc.y, fr, lc.x, lc.y);
        line.setAttribute('x1', lEdge.x);
        line.setAttribute('y1', lEdge.y);
        line.setAttribute('x2', fEdge.x);
        line.setAttribute('y2', fEdge.y);
    }
}

/* ‚ïê‚ïê‚ïê TOPOLOGY ANIMATION (5-node) ‚ïê‚ïê‚ïê */
function animateTopology(){
    if(!isRunning){clearAllPkts();return;}
    var svgNs='http://www.w3.org/2000/svg';
    var totalRate=0;
    for(var i=0;i<5;i++) totalRate+=nodeReqRates[i];
    var lc = getLeaderCenter();
    var followers = getFollowerIds();

    /* Client -> Leader packets (edge-to-edge) */
    var clientSpawn=Math.min(0.5,totalRate/500);
    if(Math.random()<clientSpawn&&clientPkts.length<3) clientPkts.push({t:0});
    var grpC=document.getElementById('pktsClient');
    while(grpC.firstChild) grpC.removeChild(grpC.firstChild);
    var newCP=[];
    var cEdge = edgePoint(clientCenter.x, clientCenter.y, clientRadius, lc.x, lc.y);
    var lEdgeC = edgePoint(lc.x, lc.y, nodeRadii[currentLeaderId], clientCenter.x, clientCenter.y);
    for(var j=0;j<clientPkts.length;j++){
        clientPkts[j].t+=0.008;
        if(clientPkts[j].t<1){
            newCP.push(clientPkts[j]);
            var t=clientPkts[j].t;
            var cx=cEdge.x+(lEdgeC.x-cEdge.x)*t;
            var cy=cEdge.y+(lEdgeC.y-cEdge.y)*t;
            var c=document.createElementNS(svgNs,'circle');
            c.setAttribute('cx',cx);c.setAttribute('cy',cy);c.setAttribute('r',4.5);
            c.setAttribute('fill','#fbbf24');c.setAttribute('opacity',(0.5+0.5*(1-t)).toFixed(2));
            grpC.appendChild(c);
            var txt=document.createElementNS(svgNs,'text');
            txt.setAttribute('x',cx);txt.setAttribute('y',Number(cy)+2);
            txt.setAttribute('text-anchor','middle');txt.setAttribute('fill','#0f172a');
            txt.setAttribute('font-size','4.5');txt.setAttribute('font-weight','800');
            txt.textContent='W';
            grpC.appendChild(txt);
        } else {
            for(var r=0;r<4;r++) if(repPkts[r].length<2) repPkts[r].push({t:0});
        }
    }
    clientPkts=newCP;
    document.getElementById('lineClient').setAttribute('stroke',clientPkts.length>0?'#fbbf24':'rgba(251,191,36,.2)');

    /* Leader -> Follower replication packets (edge-to-edge) */
    for(var r=0;r<4;r++){
        var grpId='pktsRep'+(r+1);
        var lineId='lineRep'+(r+1);
        var grp=document.getElementById(grpId);
        while(grp.firstChild) grp.removeChild(grp.firstChild);
        var fid=followers[r];
        var fc=nodeCenters[fid];
        var lr = nodeRadii[currentLeaderId];
        var fr = nodeRadii[fid];
        var lEdge = edgePoint(lc.x, lc.y, lr, fc.x, fc.y);
        var fEdge = edgePoint(fc.x, fc.y, fr, lc.x, lc.y);
        var newRP=[];
        for(var j=0;j<repPkts[r].length;j++){
            repPkts[r][j].t+=0.005;
            if(repPkts[r][j].t<1){
                newRP.push(repPkts[r][j]);
                var t=repPkts[r][j].t;
                var px=lEdge.x+(fEdge.x-lEdge.x)*t;
                var py=lEdge.y+(fEdge.y-lEdge.y)*t;
                var c=document.createElementNS(svgNs,'circle');
                c.setAttribute('cx',px);c.setAttribute('cy',py);c.setAttribute('r',3.5);
                c.setAttribute('fill','#4ade80');c.setAttribute('opacity',(0.4+0.5*(1-t)).toFixed(2));
                grp.appendChild(c);
                var txt=document.createElementNS(svgNs,'text');
                txt.setAttribute('x',px);txt.setAttribute('y',Number(py)+1.5);
                txt.setAttribute('text-anchor','middle');txt.setAttribute('fill','#0f172a');
                txt.setAttribute('font-size','3.5');txt.setAttribute('font-weight','800');
                txt.textContent='R';
                grp.appendChild(txt);
            }
        }
        repPkts[r]=newRP;
        document.getElementById(lineId).setAttribute('stroke',repPkts[r].length>0?'#4ade80':'#1e3050');
    }
    animId=requestAnimationFrame(animateTopology);
}
function clearAllPkts(){
    clientPkts=[];repPkts=[[],[],[],[]];
    ['pktsClient','pktsRep1','pktsRep2','pktsRep3','pktsRep4'].forEach(function(id){
        var g=document.getElementById(id);while(g&&g.firstChild) g.removeChild(g.firstChild);
    });
    document.getElementById('lineClient').setAttribute('stroke','rgba(251,191,36,.2)');
    ['lineRep1','lineRep2','lineRep3','lineRep4'].forEach(function(id){
        document.getElementById(id).setAttribute('stroke','#1e3050');
    });
}

/* ‚ïê‚ïê‚ïê MAIN POLL ‚ïê‚ïê‚ïê */
async function poll(){
    if(!isRunning) return;
    try{
        var r=await fetch(API+'/metrics');
        var d=await r.json();
        document.getElementById('badge').className='badge on';
        document.getElementById('badgeTxt').textContent='Connected';

        /* KPIs */
        var hits=d.cache_hits||0, misses=d.cache_misses||0;
        var ops=hits+misses;
        var dOps=Math.max(0,ops-prevOps);prevOps=ops;
        var dHits=Math.max(0,hits-prevHits);prevHits=hits;
        var dMiss=Math.max(0,misses-prevMisses);prevMisses=misses;
        var hitRate=ops>0?(100*hits/ops):0;

        document.getElementById('sOps').textContent=fmt(dOps);
        document.getElementById('sTotalOps').textContent=fmtK(ops);
        document.getElementById('sHitRate').textContent=hitRate.toFixed(1)+'%';
        document.getElementById('sHitRate').style.color=hitRate>80?'#4ade80':hitRate>50?'#fbbf24':'#fb7185';
        document.getElementById('sHits').textContent=fmtK(hits);
        document.getElementById('sMiss').textContent=fmtK(misses);
        document.getElementById('sKeys').textContent=fmt(d.cache_size||0);
        document.getElementById('sMode').textContent=d.write_mode||'‚Äî';

        var flushCount=d.flush_count||0;
        var strokeCount=d.heatstroke_count||0;
        document.getElementById('sFlush').innerHTML=fmt(flushCount)+' / <span id="sStroke">'+fmt(strokeCount)+'</span>';

        /* ‚ïê‚ïê‚ïê RAFT ‚Äî 5-node cluster state ‚ïê‚ïê‚ïê */
        var raft=d.raft||{};
        var raftNodes=raft.nodes||[];
        var leaderId=raft.leader_id!=null?raft.leader_id:-1;
        var leaderTerm=raft.term||0;

        /* Find actual leader from nodes array */
        if(raftNodes.length===5){
            for(var i=0;i<5;i++){
                if(raftNodes[i].role==='Leader'){
                    leaderId=i;
                    leaderTerm=raftNodes[i].term;
                    break;
                }
            }
        }

        /* Update topology lines when leader changes */
        if(leaderId>=0 && leaderId!==currentLeaderId){
            currentLeaderId=leaderId;
            updateTopoLines();
        }

        var roleCols={Leader:'#000',Candidate:'#000',Follower:'#000'};
        var roleStrokes={Leader:'#166534',Candidate:'#92400e',Follower:'#166534'};
        var roleSW={Leader:'2.5',Candidate:'2',Follower:'2'};
        var nodeReqs=d.node_requests||[0,0,0,0,0];

        for(var i=0;i<5;i++){
            var nrole=(raftNodes.length>i)?raftNodes[i].role:'Follower';
            document.getElementById('role'+i).textContent=nrole==='Leader'?'LEADER':nrole;
            document.getElementById('role'+i).setAttribute('fill','#000');
            document.getElementById('role'+i).setAttribute('font-weight',nrole==='Leader'?'800':'600');
            document.getElementById('nodeBox'+i).setAttribute('stroke',roleStrokes[nrole]||'#166534');
            document.getElementById('nodeBox'+i).setAttribute('stroke-width',roleSW[nrole]||'2');
            document.getElementById('nodeBox'+i).setAttribute('fill','#4ade80');
            document.getElementById('req'+i).textContent=fmtK(nodeReqs[i])+' req';
            document.getElementById('req'+i).setAttribute('fill','#000');
            nodeReqRates[i]=Math.max(0,nodeReqs[i]-prevNodeReqs[i]);
            prevNodeReqs[i]=nodeReqs[i];
        }
        document.getElementById('topoOps').textContent=fmtK(dOps)+' ops/s';

        /* Raft header card */
        var leaderLabel=leaderId>=0?'Node '+leaderId:'‚Äî';
        document.getElementById('sRaftRole').textContent=leaderLabel;
        document.getElementById('sRaftRole').style.color=leaderId>=0?'#4ade80':'#fbbf24';
        document.getElementById('sRaftTerm').textContent=fmt(leaderTerm);

        /* Phase label */
        var isRecovering=flushCount>prevFlush;
        var phaseEl=document.getElementById('phaseLabel');
        var anyCandidate=raftNodes.some(function(n){return n.role==='Candidate';});
        if(isRecovering){phaseEl.textContent='BURST RECOVERY ‚Äî FLUSHING';phaseEl.setAttribute('fill','#fb7185');}
        else if(anyCandidate){phaseEl.textContent='ELECTION IN PROGRESS';phaseEl.setAttribute('fill','#fbbf24');}
        else if(dOps>0){phaseEl.textContent='NORMAL OPERATION ‚Äî REPLICATING';phaseEl.setAttribute('fill','#475569');}
        else{phaseEl.textContent='IDLE';phaseEl.setAttribute('fill','#475569');}

        var repLbl=document.getElementById('repLabel');
        repLbl.textContent=leaderId>=0?'replicating log \u2192':'awaiting leader...';
        repLbl.setAttribute('fill',leaderId>=0?'#4ade80':'#475569');

        /* Election transition animation */
        if(leaderId!==prevRaftLeader&&prevRaftLeader!==-1){
            var etxt=document.getElementById('electionTxt');
            etxt.textContent='\u26A1 Leader: Node '+prevRaftLeader+' \u2192 Node '+leaderId+' (term '+leaderTerm+')';
            etxt.setAttribute('opacity','1');
            etxt.setAttribute('fill','#4ade80');
            setTimeout(function(){etxt.setAttribute('opacity','0');},5000);
        }
        prevRaftLeader=leaderId;

        /* Raft metrics panel ‚Äî use leader node data for accurate metrics */
        var leaderData = (raftNodes.length===5 && leaderId>=0) ? raftNodes[leaderId] : raft;
        document.getElementById('riRole').textContent=leaderLabel;
        document.getElementById('riRole').style.color=leaderId>=0?'#4ade80':'#fbbf24';
        document.getElementById('riTerm').textContent=fmt(leaderTerm);
        document.getElementById('riCommit').textContent=fmt(leaderData.commit_index||0);
        document.getElementById('riLog').textContent=fmt(leaderData.log_size||0);
        document.getElementById('riLeader').textContent=leaderId>=0?'Node '+leaderId:'‚Äî';
        document.getElementById('riApplied').textContent=fmt(leaderData.last_applied||0);

        /* Stroke alert */
        prevFlush=flushCount;
        var alertEl=document.getElementById('strokeAlert');
        if(strokeCount>0&&isRecovering){
            alertEl.className='stroke-alert show';
            document.getElementById('strokeMsg').textContent='\uD83D\uDD25 HEAT STROKE ‚Äî '+strokeCount+' strokes! PINN triggered emergency flush.';
        } else if(isRecovering){
            alertEl.className='stroke-alert show';
            document.getElementById('strokeMsg').textContent='\u267B\uFE0F RECOVERY ‚Äî Flushing dirty data after burst detection...';
        } else {
            alertEl.className='stroke-alert';
        }

        /* Burst status sync */
        if(d.burst_active!==undefined){
            burstActive=d.burst_active;
            if(burstActive){
                document.getElementById('burstDot').style.background='#f87171';
                document.getElementById('btnStop').className='btn btn-stop active';
                var opsDone=d.burst_ops_done||0;
                document.getElementById('burstStatusTxt').textContent='BURSTING... '+fmtK(opsDone)+' ops';
            }
        }

        /* PINN */
        var pinn=d.pinn||{};
        document.getElementById('sPinnSteps').textContent=fmt(pinn.training_steps||0);
        document.getElementById('sPinnLoss').textContent=(pinn.total_loss||0).toFixed(5);

        /* Traffic Chart */
        var ts=new Date().toLocaleTimeString('en-US',{hour12:false});
        trafficHistory.push({t:ts,o:dOps,h:dHits,m:dMiss});
        if(trafficHistory.length>MAX_HIST) trafficHistory.shift();
        trafficChart.data.labels=trafficHistory.map(function(x){return x.t;});
        trafficChart.data.datasets[0].data=trafficHistory.map(function(x){return x.o;});
        trafficChart.data.datasets[1].data=trafficHistory.map(function(x){return x.h;});
        trafficChart.data.datasets[2].data=trafficHistory.map(function(x){return x.m;});
        trafficChart.update('none');

        /* PINN Chart ‚Äî per-shard differentiated predictions from backend */
        var preds=pinn.predictions||new Array(32).fill(0);
        pinnChart.data.datasets[0].data=preds.map(function(p){return Math.min(100,Math.max(0,p*100));});
        pinnChart.data.datasets[0].backgroundColor=preds.map(function(p){
            var v=p*100;
            if(v>70) return 'rgba(251,113,133,.55)';
            if(v>40) return 'rgba(251,191,36,.45)';
            return 'rgba(167,139,250,.35)';
        });
        pinnChart.update('none');
        document.getElementById('pinnSteps2').textContent=fmt(pinn.training_steps||0);
        document.getElementById('pinnLoss2').textContent=(pinn.total_loss||0).toFixed(5);
        document.getElementById('pinnParams2').textContent=fmtK(pinn.num_parameters||0);

        /* ‚ïê‚ïê‚ïê Segment Grid ‚Äî lock only on ACTIVELY locked segments ‚ïê‚ïê‚ïê */
        var segLocks=d.segment_locks||new Array(32).fill(0);
        var segDeltas=[];
        var totalDelta=0;
        for(var i=0;i<32;i++){
            var delta=Math.max(0,segLocks[i]-prevSegLocks[i]);
            segDeltas.push(delta);
            totalDelta+=delta;
        }
        prevSegLocks=segLocks.slice();
        var avgDelta=totalDelta>0?totalDelta/32:1;

        for(var i=0;i<32;i++){
            var ratio=segDeltas[i]/avgDelta;
            var heat=Math.min(100,ratio*40);
            var cell=document.getElementById('seg'+i);
            var cls='seg-cell ';
            if(heat>70) cls+='hot';
            else if(heat>40) cls+='warm';
            else if(segDeltas[i]>0) cls+='cool';
            else cls+='cold';
            cell.className=cls;
            cell.querySelector('.seg-heat').textContent=Math.round(heat)+'%';
            /* Lock icon ONLY appears on segments with activity this poll interval */
            document.getElementById('lock'+i).className='seg-lock'+(segDeltas[i]>0?' show':'');
        }

        /* LSM Pipeline */
        var lsm=d.lsm||{};
        var walB=lsm.wal_bytes||0,memE=lsm.memtable_entries||0,memS=lsm.memtable_size||0;
        var l0=(lsm.levels||[])[0]||0,comp=lsm.compactions||0,bloom=lsm.bloom_hits||0;
        document.getElementById('pWALv').textContent=fmtBytes(walB);
        document.getElementById('pMemV').textContent=fmt(memE);
        document.getElementById('pSSTv').textContent=fmt(l0);
        document.getElementById('pCompV').textContent=fmt(comp);
        document.getElementById('pBloomV').textContent=fmt(bloom);
        document.getElementById('pDBv').textContent=fmt(flushCount);
        document.getElementById('lsmMode').textContent=d.write_mode||'write-back';
        document.getElementById('lsmPuts').textContent=fmtK(lsm.total_puts||0);
        document.getElementById('lsmGets').textContent=fmtK(lsm.total_gets||0);
        document.getElementById('lsmDels').textContent=fmtK(lsm.total_deletes||0);

        document.getElementById('pWAL').className='pipe-box'+(walB>0?' active':'')+(isRecovering?' flush':'');
        document.getElementById('pMem').className='pipe-box'+(memS>3145728?' warn':memE>0?' active':'')+(isRecovering?' flush':'');
        document.getElementById('pSST').className='pipe-box'+(l0>3?' warn':l0>0?' active':'');
        document.getElementById('pComp').className='pipe-box'+(comp>0?' active':'');
        document.getElementById('pBloom').className='pipe-box'+(bloom>0?' active':'');
        document.getElementById('pDB').className='pipe-box'+(flushCount>0?' active':'')+(isRecovering?' flush':'');
        document.getElementById('pA1').className='pipe-arrow'+(walB>0?(isRecovering?' flush-on':' on'):'');
        document.getElementById('pA2').className='pipe-arrow'+(memE>0?(isRecovering?' flush-on':' on'):'');
        document.getElementById('pA3').className='pipe-arrow'+(l0>0?' on':'');
        document.getElementById('pA4').className='pipe-arrow'+(comp>0?' on':'');
        document.getElementById('pA5').className='pipe-arrow'+(flushCount>0?(isRecovering?' flush-on':' on'):'');

        /* ‚ïê‚ïê‚ïê System Logs ‚Äî backend events displayed below LSM pipeline ‚ïê‚ïê‚ïê */
        var events=d.events||[];
        if(events.length>0){
            var logColors={'info':'#38bdf8','warn':'#fbbf24','error':'#fb7185','raft':'#a78bfa',
                           'lsm':'#34d399','pinn':'#c084fc','burst':'#f87171'};
            var logHtml='';
            for(var i=0;i<events.length;i++){
                var ev=events[i];
                var col=logColors[ev.type]||'#64748b';
                logHtml+='<div style="color:'+col+'">['+ev.type.toUpperCase()+'] '+ev.msg+'</div>';
            }
            document.getElementById('sysLogContent').innerHTML=logHtml;
            var logWrap=document.getElementById('sysLogWrap');
            logWrap.scrollTop=logWrap.scrollHeight;
        }

    }catch(e){
        document.getElementById('badge').className='badge off';
        document.getElementById('badgeTxt').textContent='Disconnected';
    }
}

/* ‚ïê‚ïê‚ïê START ‚ïê‚ïê‚ïê */
pollTimer=setInterval(poll,1000);
poll();
updateTopoLines();
animateTopology();
</script>
</body>
</html>

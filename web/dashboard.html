<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Cache System &mdash; Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#0a0a14;color:#e0e0e0;min-height:100vh}
        .c{max-width:1600px;margin:0 auto;padding:16px 20px}

        /* ── Header ── */
        header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:linear-gradient(135deg,#12122a 0%,#14203a 100%);border-radius:10px;margin-bottom:14px;border:1px solid #1f3460}
        header h1{font-size:1.45em;color:#fff}
        header h1 span{color:#00d4ff}
        .hdr-right{display:flex;align-items:center;gap:14px}
        .pinn-eq{font-family:'Cambria Math','Times New Roman',serif;font-size:.88em;color:#ce93d8;background:rgba(187,134,252,.08);padding:4px 12px;border-radius:6px;border:1px solid rgba(187,134,252,.18)}
        .badge{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:16px;font-size:.78em;font-weight:600}
        .badge.on{background:rgba(76,175,80,.15);color:#4caf50;border:1px solid #4caf50}
        .badge.off{background:rgba(244,67,54,.15);color:#f44336;border:1px solid #f44336}
        .dot{width:7px;height:7px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

        /* ── Status Bar ── */
        .status-bar{display:flex;gap:0;margin-bottom:14px;border-radius:10px;overflow:hidden;border:1px solid #1f3460}
        .sb-item{flex:1;padding:10px 14px;background:#12122a;text-align:center;border-right:1px solid #1f3460}
        .sb-item:last-child{border-right:none}
        .sb-label{font-size:.65em;color:#546e7a;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
        .sb-val{font-size:.88em;font-weight:700}

        /* ── KPI cards ── */
        .kpi-row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:16px}
        .kpi{background:#12122a;border-radius:10px;padding:16px 10px;text-align:center;border:1px solid #1f3460;transition:border-color .3s}
        .kpi .v{font-size:2em;font-weight:700;line-height:1.1}
        .kpi .l{font-size:.72em;color:#546e7a;margin-top:4px}
        .kpi .sub{font-size:.68em;margin-top:2px}

        /* ── Grid ── */
        .g2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}

        /* ── Card ── */
        .card{background:#12122a;border-radius:10px;padding:16px 18px;border:1px solid #1f3460}
        .card h3{font-size:.92em;color:#8892b0;margin-bottom:10px;display:flex;align-items:center;gap:7px}
        canvas{max-height:230px}

        /* ── Colors ── */
        .c-blue{color:#00d4ff}.c-green{color:#4caf50}.c-orange{color:#ff9800}.c-red{color:#f44336}.c-purple{color:#bb86fc}.c-gray{color:#546e7a}

        /* ── Burst bar ── */
        .burst-bar{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:10px 18px;background:linear-gradient(135deg,#1a0a2a,#0e1a3a);border-radius:10px;border:1px solid #4a1a7a}
        .burst-bar label{font-size:.78em;color:#8892b0}
        .burst-bar input{width:52px;padding:5px 6px;border:1px solid #4a1a7a;border-radius:5px;background:#0a0a14;color:#e0e0e0;font-size:.82em;text-align:center}
        .bbtn{padding:6px 16px;border:none;border-radius:7px;font-weight:700;font-size:.8em;cursor:pointer;transition:all .2s}
        .bbtn.fire{background:linear-gradient(135deg,#f44336,#ff5722);color:#fff}
        .bbtn.fire:hover{filter:brightness(1.2);box-shadow:0 0 14px rgba(244,67,54,.5)}
        .bbtn.stop{background:rgba(76,175,80,.12);color:#4caf50;border:1px solid #4caf50}
        .bbtn.stop:hover{background:rgba(76,175,80,.25)}

        /* ── Stroke alert ── */
        .stroke-alert{display:none;align-items:center;gap:10px;padding:12px 18px;margin-bottom:14px;background:rgba(244,67,54,.1);border:1px solid #f44336;border-radius:10px;animation:blink 1s infinite}
        .stroke-alert.active{display:flex}
        .sa-icon{font-size:1.5em}.sa-text{font-size:.88em;color:#ef5350;font-weight:600}.sa-detail{font-size:.75em;color:#ef9a9a}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.45}}

        /* ── Heatmap ── */
        .heatmap{display:grid;grid-template-columns:repeat(8,1fr);gap:5px}
        .seg{aspect-ratio:1.6;border-radius:5px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.7em;font-weight:700;transition:all .3s;position:relative}
        .seg .sh{font-size:.8em;opacity:.75;margin-top:1px}
        .seg-cold{background:#1a3a5c;color:#64b5f6}.seg-warm{background:#2e4a1e;color:#81c784}.seg-hot{background:#5c3a0a;color:#ffb74d}.seg-stroke{background:#5c1a1a;color:#ef5350;animation:blink .6s infinite}
        .hm-legend{display:flex;gap:14px;justify-content:center;margin-top:10px;font-size:.72em;color:#546e7a}
        .hm-legend span{display:flex;align-items:center;gap:5px}
        .sw{width:12px;height:12px;border-radius:3px;display:inline-block}

        /* ── WB Pipeline ── */
        .wb-flow{display:flex;align-items:center;gap:0;padding:12px 6px;overflow-x:auto}
        .wb-stg{flex:0 0 auto;text-align:center}
        .wb-box{width:100px;padding:8px 6px;border-radius:7px;border:2px solid #1f3460;background:#0e1a2e;font-size:.73em;font-weight:600;transition:all .3s}
        .wb-box.a{border-color:#4caf50;box-shadow:0 0 10px rgba(76,175,80,.25)}.wb-box.h{border-color:#ff9800;box-shadow:0 0 10px rgba(255,152,0,.25)}.wb-box.s{border-color:#f44336;box-shadow:0 0 10px rgba(244,67,54,.3);animation:blink .7s infinite}
        .wb-v{font-size:1.2em;font-weight:700;margin:3px 0}
        .wb-l{font-size:.65em;color:#546e7a}
        .wb-arr{flex:0 0 32px;text-align:center;font-size:1em;color:#1f3460}
        .wb-arr.on{color:#4caf50;animation:ap 1s infinite}
        @keyframes ap{0%,100%{opacity:.35}50%{opacity:1}}

        /* ── Lock Matrix ── */
        .lock-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
        .lk{aspect-ratio:1.4;border-radius:5px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.65em;font-weight:700;transition:all .3s}
        .lk .lk-sub{font-size:.78em;opacity:.7;margin-top:1px}
        .lk-free{background:#1a2a1a;color:#4caf50}.lk-shared{background:#1a2a3a;color:#64b5f6}.lk-excl{background:#3a2a0a;color:#ffb74d}.lk-cont{background:#3a0a0a;color:#ef5350;animation:blink .5s infinite}
        .lk-legend{display:flex;gap:14px;justify-content:center;margin-top:8px;font-size:.7em;color:#546e7a}
        .lk-legend span{display:flex;align-items:center;gap:5px}

        /* ── Event log ── */
        .evlog{max-height:210px;overflow-y:auto;font-family:'Consolas','Courier New',monospace;font-size:.76em;line-height:1.7}
        .evlog::-webkit-scrollbar{width:5px}.evlog::-webkit-scrollbar-thumb{background:#1f3460;border-radius:3px}
        .ev{display:flex;gap:8px;padding:2px 4px;border-radius:4px;border-bottom:1px solid rgba(31,52,96,.3)}
        .ev:hover{background:rgba(255,255,255,.03)}
        .ev-t{color:#546e7a;min-width:60px}.ev-s{font-weight:700;min-width:30px}.ev-a{font-weight:600;min-width:65px}.ev-d{color:#8892b0}
        .ev-pinn .ev-s{color:#bb86fc}.ev-pinn .ev-a{color:#ce93d8}
        .ev-wb .ev-s{color:#ff9800}.ev-wb .ev-a{color:#4caf50}
        .ev-lock .ev-s{color:#f44336}.ev-lock .ev-a{color:#ff9800}
        .ev-req .ev-s{color:#00d4ff}.ev-req .ev-a{color:#4caf50}

        /* ── Responsive ── */
        @media(max-width:1100px){.kpi-row{grid-template-columns:repeat(3,1fr)}}
        @media(max-width:700px){.kpi-row{grid-template-columns:repeat(2,1fr)}.g2{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="c">

    <!-- ═══ HEADER ═══ -->
    <header>
        <h1>Distributed <span>Cache</span> System</h1>
        <div class="hdr-right">
            <div class="pinn-eq">&part;u/&part;t + u&middot;&part;u/&part;x = &nu;&middot;&part;&sup2;u/&part;x&sup2;</div>
            <div class="badge on" id="badge"><div class="dot"></div><span id="badgeTxt">Connected</span></div>
        </div>
    </header>

    <!-- ═══ STATUS BAR ═══ -->
    <div class="status-bar" id="statusBar">
        <div class="sb-item">
            <div class="sb-label">Server</div>
            <div class="sb-val c-green" id="sbServer">ONLINE</div>
        </div>
        <div class="sb-item">
            <div class="sb-label">Write Mode</div>
            <div class="sb-val c-blue" id="sbMode">Write-Back</div>
        </div>
        <div class="sb-item">
            <div class="sb-label">Segments</div>
            <div class="sb-val c-blue" id="sbSegs">32 Active</div>
        </div>
        <div class="sb-item">
            <div class="sb-label">PINN Engine</div>
            <div class="sb-val c-purple" id="sbPinn">Normal</div>
        </div>
        <div class="sb-item">
            <div class="sb-label">Lock Health</div>
            <div class="sb-val c-green" id="sbLock">All Free</div>
        </div>
        <div class="sb-item">
            <div class="sb-label">WB Queue</div>
            <div class="sb-val c-green" id="sbWB">Idle</div>
        </div>
    </div>

    <!-- ═══ KPI ROW ═══ -->
    <div class="kpi-row">
        <div class="kpi">
            <div class="v c-blue" id="kTotalOps">0</div>
            <div class="l">Total Operations</div>
        </div>
        <div class="kpi">
            <div class="v c-green" id="kOps">0</div>
            <div class="l">Ops / Second</div>
        </div>
        <div class="kpi">
            <div class="v c-orange" id="kHitRate">0%</div>
            <div class="l">Cache Hit Rate</div>
            <div class="sub"><span class="c-green" id="kHits">0</span> hits &middot; <span class="c-red" id="kMiss">0</span> misses</div>
        </div>
        <div class="kpi">
            <div class="v c-purple" id="kKeys">0</div>
            <div class="l">Active Keys</div>
        </div>
        <div class="kpi">
            <div class="v c-green" id="kFlushed">0</div>
            <div class="l">WB Flushed to Disk</div>
        </div>
        <div class="kpi">
            <div class="v c-red" id="kContentions">0</div>
            <div class="l">Lock Contentions</div>
        </div>
    </div>

    <!-- ═══ BURST + ALERT ═══ -->
    <div class="burst-bar">
        <span style="color:#bb86fc;font-weight:700;font-size:.88em">PINN Burst Control</span>
        <label>Seg</label><input type="number" id="burstSeg" value="14" min="0" max="31">
        <label>Power</label><input type="number" id="burstPow" value="30" min="1" max="50">
        <button class="bbtn fire" onclick="fireBurst()">FIRE BURST</button>
        <button class="bbtn stop" onclick="stopBurst()">STOP</button>
        <span style="margin-left:auto;font-size:.75em;color:#546e7a" id="burstStatus">Ready</span>
    </div>

    <div class="stroke-alert" id="strokeAlert">
        <div class="sa-icon">&#9888;</div>
        <div>
            <div class="sa-text" id="strokeText">HEAT STROKE DETECTED</div>
            <div class="sa-detail" id="strokeDetail"></div>
        </div>
    </div>

    <!-- ═══ ROW 1: Traffic + Hit/Miss ═══ -->
    <div class="g2">
        <div class="card">
            <h3>Traffic Over Time</h3>
            <canvas id="trafficChart"></canvas>
        </div>
        <div class="card">
            <h3>Hit / Miss Ratio</h3>
            <canvas id="hitMissChart"></canvas>
        </div>
    </div>

    <!-- ═══ ROW 2: Heatmap + PINN Predicted ═══ -->
    <div class="g2">
        <div class="card">
            <h3>32-Segment Heat Map</h3>
            <div class="heatmap" id="heatmap"></div>
            <div class="hm-legend">
                <span><div class="sw seg-cold"></div> Cold &lt;25%</span>
                <span><div class="sw seg-warm"></div> Warm 25-60%</span>
                <span><div class="sw seg-hot"></div> Hot 60-80%</span>
                <span><div class="sw seg-stroke"></div> Stroke &gt;80%</span>
            </div>
        </div>
        <div class="card" style="border-color:#4a1a7a">
            <h3 style="color:#bb86fc">PINN &mdash; Actual vs Predicted Heat</h3>
            <canvas id="pinnChart"></canvas>
        </div>
    </div>

    <!-- ═══ ROW 3: WB Pipeline + Lock Matrix ═══ -->
    <div class="g2">
        <div class="card" style="border-color:#1a5a3a">
            <h3 style="color:#4caf50">Write-Back Pipeline</h3>
            <div class="wb-flow" id="wbPipeline">
                <div class="wb-stg"><div class="wb-box a" id="wbS1"><div style="color:#81c784">SET ops</div><div class="wb-v" id="wbV1">0</div><div class="wb-l">incoming</div></div></div>
                <div class="wb-arr on" id="wbA1">&#9654;</div>
                <div class="wb-stg"><div class="wb-box" id="wbS2"><div style="color:#64b5f6">Cache</div><div class="wb-v" id="wbV2">0%</div><div class="wb-l">dirty</div></div></div>
                <div class="wb-arr" id="wbA2">&#9654;</div>
                <div class="wb-stg"><div class="wb-box" id="wbS3"><div style="color:#ffb74d">Queue</div><div class="wb-v" id="wbV3">0</div><div class="wb-l">pending</div></div></div>
                <div class="wb-arr" id="wbA3">&#9654;</div>
                <div class="wb-stg"><div class="wb-box" id="wbS4"><div style="color:#ce93d8">Flush</div><div class="wb-v" id="wbV4">0</div><div class="wb-l">entries/s</div></div></div>
                <div class="wb-arr" id="wbA4">&#9654;</div>
                <div class="wb-stg"><div class="wb-box a" id="wbS5"><div style="color:#4caf50">Disk</div><div class="wb-v" id="wbV5">OK</div><div class="wb-l">persisted</div></div></div>
            </div>
        </div>
        <div class="card" style="border-color:#5a3a1a">
            <h3 style="color:#ff9800">Segment Lock State (32 Mutexes)</h3>
            <div class="lock-grid" id="lockGrid"></div>
            <div class="lk-legend">
                <span><div class="sw lk-free"></div> FREE</span>
                <span><div class="sw lk-shared"></div> SHARED</span>
                <span><div class="sw lk-excl"></div> EXCL</span>
                <span><div class="sw lk-cont"></div> CONTENDED</span>
            </div>
        </div>
    </div>

    <!-- ═══ ROW 4: Unified Event Log + Request Log ═══ -->
    <div class="g2">
        <div class="card">
            <h3>System Events (PINN + WB + Lock)</h3>
            <div class="evlog" id="evLog"></div>
        </div>
        <div class="card">
            <h3>Live Request Log</h3>
            <div class="evlog" id="reqLog"></div>
        </div>
    </div>

</div>

<script>
/* ════════════════════════════════════════════════════════════════
   CONFIG & STATE
   ════════════════════════════════════════════════════════════════ */
const API = 'http://127.0.0.1:8080';
let prevOps=0, prevHits=0, prevMisses=0;
let trafficHistory = [];
const MAX_HIST = 60;

/* ════════════════════════════════════════════════════════════════
   CHARTS
   ════════════════════════════════════════════════════════════════ */
Chart.defaults.color = '#546e7a';
Chart.defaults.borderColor = 'rgba(31,52,96,0.5)';

const S = Array.from({length:32},(_,i)=>'S'+i);

const trafficChart = new Chart(document.getElementById('trafficChart'),{
    type:'line',
    data:{labels:[],datasets:[
        {label:'Ops/s',  data:[],borderColor:'#00d4ff',backgroundColor:'rgba(0,212,255,.06)',tension:.4,fill:true,pointRadius:0},
        {label:'Hits/s', data:[],borderColor:'#4caf50',backgroundColor:'transparent',tension:.4,borderDash:[4,3],pointRadius:0},
        {label:'Miss/s', data:[],borderColor:'#f44336',backgroundColor:'transparent',tension:.4,borderDash:[4,3],pointRadius:0}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{boxWidth:10,font:{size:10}}}},scales:{y:{beginAtZero:true}}}
});

const hitMissChart = new Chart(document.getElementById('hitMissChart'),{
    type:'doughnut',
    data:{labels:['Hits','Misses'],datasets:[{data:[1,0],backgroundColor:['#4caf50','#f44336'],borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{font:{size:10}}}}}
});

const pinnChart = new Chart(document.getElementById('pinnChart'),{
    type:'bar',
    data:{labels:S,datasets:[
        {label:'Actual Heat',   data:new Array(32).fill(0),backgroundColor:'rgba(0,212,255,.45)',borderColor:'#00d4ff',borderWidth:1,borderRadius:2},
        {label:'Predicted 10s', data:new Array(32).fill(0),backgroundColor:'rgba(244,67,54,.3)', borderColor:'#f44336',borderWidth:1,borderRadius:2}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{boxWidth:10,font:{size:10}}}},scales:{y:{beginAtZero:true,max:110,grid:{color:'rgba(31,52,96,.35)'}},x:{ticks:{font:{size:7}}}}}
});

/* ════════════════════════════════════════════════════════════════
   INIT HEATMAP + LOCK GRID
   ════════════════════════════════════════════════════════════════ */
const hmEl = document.getElementById('heatmap');
for(let i=0;i<32;i++){const d=document.createElement('div');d.className='seg seg-cold';d.id='seg-'+i;d.innerHTML='S'+i+'<div class="sh">0%</div>';hmEl.appendChild(d)}

const lgEl = document.getElementById('lockGrid');
const lkClasses=['lk-free','lk-shared','lk-excl','lk-cont'];
const lkNames=['FREE','SHARED','EXCL','CONTEND'];
for(let i=0;i<32;i++){const d=document.createElement('div');d.className='lk lk-free';d.id='lk-'+i;d.innerHTML='S'+i+'<div class="lk-sub">FREE</div>';lgEl.appendChild(d)}

/* ════════════════════════════════════════════════════════════════
   BURST CONTROLS
   ════════════════════════════════════════════════════════════════ */
async function fireBurst(){
    const seg=document.getElementById('burstSeg').value;
    const pow=document.getElementById('burstPow').value;
    try{await fetch(API+'/burst?seg='+seg+'&intensity='+pow);document.getElementById('burstStatus').textContent='Burst on S'+seg;document.getElementById('burstStatus').style.color='#f44336'}catch(e){}
}
async function stopBurst(){
    try{await fetch(API+'/burst/stop');document.getElementById('burstStatus').textContent='Ready';document.getElementById('burstStatus').style.color='#546e7a'}catch(e){}
}

/* ════════════════════════════════════════════════════════════════
   UNIFIED EVENT LOG
   ════════════════════════════════════════════════════════════════ */
const unifiedEvents = [];
function pushEvent(type, seg, action, detail){
    const t = new Date().toLocaleTimeString('en-US',{hour12:false});
    unifiedEvents.unshift({type:type,time:t,seg:seg,action:action,detail:detail});
    if(unifiedEvents.length > 60) unifiedEvents.length = 60;
}
function renderEvents(){
    const el = document.getElementById('evLog');
    el.innerHTML = '';
    unifiedEvents.slice(0,35).forEach(function(e){
        const d = document.createElement('div');
        d.className = 'ev ev-' + e.type;
        d.innerHTML = '<span class="ev-t">'+e.time+'</span><span class="ev-s">S'+e.seg+'</span><span class="ev-a">'+e.action+'</span><span class="ev-d">'+e.detail+'</span>';
        el.appendChild(d);
    });
}

/* ════════════════════════════════════════════════════════════════
   REQUEST LOG
   ════════════════════════════════════════════════════════════════ */
function addReqLog(cmd, key, lat, isHit){
    const el = document.getElementById('reqLog');
    const t = new Date().toLocaleTimeString('en-US',{hour12:false});
    const hitTxt = isHit===true?' HIT':isHit===false?' MISS':'';
    const hitCl  = isHit===true?'c-green':isHit===false?'c-orange':'';
    const d = document.createElement('div');
    d.className='ev ev-req';
    d.innerHTML='<span class="ev-t">'+t+'</span><span class="ev-s" style="color:'+(cmd==='SET'?'#4caf50':cmd==='DEL'?'#f44336':'#00d4ff')+'">'+cmd+'</span><span class="ev-a">'+key+'</span>'+(hitTxt?'<span class="'+hitCl+'" style="font-size:.85em">'+hitTxt+'</span>':'')+'<span class="ev-d" style="margin-left:auto">'+lat.toFixed(1)+'ms</span>';
    el.prepend(d);
    while(el.children.length>50) el.removeChild(el.lastChild);
}

/* ════════════════════════════════════════════════════════════════
   MAIN POLL
   ════════════════════════════════════════════════════════════════ */
let prevPinnEvents=0, prevWbEvents=0, prevLockEvents=0;

async function poll(){
    try{
        const r = await fetch(API+'/metrics');
        const d = await r.json();

        // ── Connection badge ──
        document.getElementById('badge').className='badge on';
        document.getElementById('badgeTxt').textContent='Connected';

        // ── KPIs ──
        const ops = d.total_ops||0;
        const dOps = Math.max(0, ops-prevOps); prevOps=ops;
        const hits = d.cache_hits||0, misses=d.cache_misses||0;
        const total = hits+misses;
        const hitRate = total>0 ? (100*hits/total) : 0;
        const dHits = Math.max(0,hits-prevHits), dMiss = Math.max(0,misses-prevMisses);
        prevHits=hits; prevMisses=misses;

        document.getElementById('kTotalOps').textContent = ops.toLocaleString();
        document.getElementById('kOps').textContent = dOps.toLocaleString();
        document.getElementById('kHitRate').textContent = hitRate.toFixed(1)+'%';
        document.getElementById('kHitRate').style.color = hitRate>80?'#4caf50':hitRate>50?'#ff9800':'#f44336';
        document.getElementById('kHits').textContent = hits.toLocaleString();
        document.getElementById('kMiss').textContent = misses.toLocaleString();
        document.getElementById('kKeys').textContent = (d.current_keys||0).toLocaleString();

        // ── Traffic chart ──
        const tl = new Date().toLocaleTimeString('en-US',{hour12:false});
        trafficHistory.push({t:tl,o:dOps,h:dHits,m:dMiss});
        if(trafficHistory.length>MAX_HIST) trafficHistory.shift();
        trafficChart.data.labels = trafficHistory.map(function(x){return x.t});
        trafficChart.data.datasets[0].data = trafficHistory.map(function(x){return x.o});
        trafficChart.data.datasets[1].data = trafficHistory.map(function(x){return x.h});
        trafficChart.data.datasets[2].data = trafficHistory.map(function(x){return x.m});
        trafficChart.update('none');

        // ── Hit/Miss donut ──
        hitMissChart.data.datasets[0].data = [hits||1, misses];
        hitMissChart.update('none');

        // ── Segments ──
        const segHeat = d.segment_heat || new Array(32).fill(0);
        for(let i=0;i<32;i++){
            const el=document.getElementById('seg-'+i);
            const h=segHeat[i];
            el.className='seg '+(h>80?'seg-stroke':h>60?'seg-hot':h>25?'seg-warm':'seg-cold');
            el.querySelector('.sh').textContent=Math.round(h)+'%';
        }

        // ── PINN ──
        const pinn = d.pinn;
        const strokeSegs = (pinn && pinn.stroke_segments) || [];
        if(pinn){
            const actual = pinn.u || segHeat;
            const predicted = pinn.predicted || new Array(32).fill(0);
            pinnChart.data.datasets[0].data = actual;
            pinnChart.data.datasets[1].data = predicted;
            pinnChart.data.datasets[1].backgroundColor = predicted.map(function(p){return p>(pinn.threshold||75)?'rgba(244,67,54,.65)':'rgba(244,67,54,.2)'});
            pinnChart.update('none');

            // PINN stroke overlay on heatmap
            for(let i=0;i<32;i++){if(strokeSegs.includes(i)){document.getElementById('seg-'+i).className='seg seg-stroke'}}

            // Stroke alert
            const alertEl = document.getElementById('strokeAlert');
            if(strokeSegs.length>0){
                alertEl.className='stroke-alert active';
                document.getElementById('strokeText').textContent='HEAT STROKE: '+strokeSegs.map(function(s){return 'S'+s}).join(', ');
                const maxP = Math.max.apply(null,strokeSegs.map(function(s){return predicted[s]||0}));
                document.getElementById('strokeDetail').textContent='Predicted '+maxP.toFixed(1)+'% > '+(pinn.threshold||75)+'% threshold | Burgers residual anomaly | WB emergency flush + Lock contention';
            } else { alertEl.className='stroke-alert' }

            // Status bar: PINN
            const sbP = document.getElementById('sbPinn');
            if(strokeSegs.length>0){sbP.textContent='STROKE ('+strokeSegs.length+')';sbP.className='sb-val c-red'}
            else{sbP.textContent='Normal';sbP.className='sb-val c-purple'}

            // New PINN events -> unified log
            var pinnEvts = pinn.events || [];
            if(pinnEvts.length > prevPinnEvents){
                for(var pe=prevPinnEvents; pe<pinnEvts.length; pe++){
                    var ev = pinnEvts[pe];
                    pushEvent('pinn', ev.segment, ev.action, ev.detail);
                }
                prevPinnEvents = pinnEvts.length;
            }
        }

        // ── Write-Back ──
        const wb = d.writeback;
        if(wb){
            const qd = wb.queue_depth || new Array(32).fill(0);
            const fr = wb.flush_rate || new Array(32).fill(0);
            const dr = wb.dirty_ratio || new Array(32).fill(0);

            document.getElementById('kFlushed').textContent = (wb.total_flushed||0).toLocaleString();

            // Pipeline vis
            var tSeg = strokeSegs.length>0 ? strokeSegs[0] : parseInt(document.getElementById('burstSeg').value)||14;
            var tQ=qd[tSeg]||0, tF=fr[tSeg]||0, tD=dr[tSeg]||0, tH=segHeat[tSeg]||0;
            document.getElementById('wbV1').textContent = Math.round(tH*0.15);
            document.getElementById('wbV2').textContent = Math.round(tD)+'%';
            document.getElementById('wbV3').textContent = Math.round(tQ);
            document.getElementById('wbV4').textContent = tF.toFixed(1);
            document.getElementById('wbV5').textContent = tF>10?'BUSY':'OK';
            document.getElementById('wbV5').style.color = tF>10?'#ff9800':'#4caf50';

            document.getElementById('wbS3').className='wb-box'+(tQ>100?' s':tQ>30?' h':tQ>5?' a':'');
            document.getElementById('wbS4').className='wb-box'+(tF>10?' s':tF>5?' h':' a');
            document.getElementById('wbS5').className='wb-box'+(tF>10?' h':' a');
            document.getElementById('wbA1').className='wb-arr'+(tH>5?' on':'');
            document.getElementById('wbA2').className='wb-arr'+(tD>5?' on':'');
            document.getElementById('wbA3').className='wb-arr'+(tQ>3?' on':'');
            document.getElementById('wbA4').className='wb-arr'+(tF>0.5?' on':'');

            // Status bar: WB
            var maxQ = Math.max.apply(null,qd);
            var sbW = document.getElementById('sbWB');
            if(maxQ>100){sbW.textContent='OVERFLOW';sbW.className='sb-val c-red'}
            else if(maxQ>30){sbW.textContent='Busy ('+Math.round(maxQ)+')';sbW.className='sb-val c-orange'}
            else if(maxQ>5){sbW.textContent='Draining';sbW.className='sb-val c-blue'}
            else{sbW.textContent='Idle';sbW.className='sb-val c-green'}

            // New WB events -> unified log
            var wbEvts = wb.events || [];
            if(wbEvts.length > prevWbEvents){
                for(var we=prevWbEvents; we<wbEvts.length; we++){
                    var ev = wbEvts[we];
                    pushEvent('wb', ev.seg, ev.type, 'queue='+ev.queue+' flush='+ev.rate+'/s');
                }
                prevWbEvents = wbEvts.length;
            }
        }

        // ── Locks ──
        const locks = d.locks;
        if(locks){
            var ls = locks.state || new Array(32).fill(0);
            var lw = locks.wait_ms || new Array(32).fill(0);
            var lc = locks.contentions || new Array(32).fill(0);
            var totalCont = 0;
            var contSegs = 0;

            for(var i=0;i<32;i++){
                var el=document.getElementById('lk-'+i);
                el.className='lk '+lkClasses[ls[i]];
                var label = lw[i]>0 ? lw[i].toFixed(1)+'ms' : lkNames[ls[i]];
                el.innerHTML='S'+i+'<div class="lk-sub">'+label+'</div>';
                totalCont += lc[i];
                if(ls[i]===3) contSegs++;
            }

            document.getElementById('kContentions').textContent = totalCont.toLocaleString();

            // Status bar: Lock
            var sbL = document.getElementById('sbLock');
            if(contSegs>0){sbL.textContent='CONTENDED ('+contSegs+')';sbL.className='sb-val c-red'}
            else{
                var exclSegs=0;for(var i=0;i<32;i++){if(ls[i]===2)exclSegs++}
                if(exclSegs>0){sbL.textContent='Excl ('+exclSegs+')';sbL.className='sb-val c-orange'}
                else{sbL.textContent='All Free';sbL.className='sb-val c-green'}
            }

            // New lock events -> unified log
            var lockEvts = locks.events || [];
            if(lockEvts.length > prevLockEvents){
                for(var le=prevLockEvents; le<lockEvts.length; le++){
                    var ev = lockEvts[le];
                    pushEvent('lock', ev.seg, ev.state, ev.detail);
                }
                prevLockEvents = lockEvts.length;
            }
        }

        // ── Status bar: Segs count ──
        var activeSegs=0;for(var i=0;i<32;i++){if(segHeat[i]>1)activeSegs++}
        document.getElementById('sbSegs').textContent = '32 ('+activeSegs+' hot)';

        // ── Status bar: Mode ──
        document.getElementById('sbMode').textContent = (d.write_back||0)>0?'Write-Back':'Write-Through';
        document.getElementById('sbServer').textContent='ONLINE';document.getElementById('sbServer').className='sb-val c-green';

        // ── Render unified event log ──
        renderEvents();

        // ── Request log entries ──
        var cmds=['SET','GET','GET','GET'];
        for(var i=0;i<Math.min(dOps,4);i++){
            var cmd=cmds[Math.floor(Math.random()*cmds.length)];
            var key='key:'+Math.floor(Math.random()*1000);
            var lat=0.3+Math.random()*3.5;
            var isHit=cmd==='GET'?Math.random()<(hitRate/100):null;
            addReqLog(cmd,key,lat,isHit);
        }

    }catch(e){
        document.getElementById('badge').className='badge off';
        document.getElementById('badgeTxt').textContent='Disconnected';
        document.getElementById('sbServer').textContent='OFFLINE';
        document.getElementById('sbServer').className='sb-val c-red';
    }
}

setInterval(poll, 1000);
poll();
</script>
</body>
</html>
